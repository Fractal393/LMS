{"ast":null,"code":"/**\r\n * DevExtreme (ui/date_box/ui.date_box.mask.js)\r\n * Version: 20.1.6\r\n * Build date: Fri Jul 17 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _utils = require(\"../../events/utils\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _dom = require(\"../../core/utils/dom\");\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _math = require(\"../../core/utils/math\");\n\nvar _events_engine = require(\"../../events/core/events_engine\");\n\nvar _events_engine2 = _interopRequireDefault(_events_engine);\n\nvar _uiDate_boxMask = require(\"./ui.date_box.mask.parts\");\n\nvar _date = require(\"../../localization/date\");\n\nvar _date2 = _interopRequireDefault(_date);\n\nvar _date3 = require(\"../../localization/ldml/date.parser\");\n\nvar _date4 = require(\"../../localization/ldml/date.format\");\n\nvar _uiDate_box = require(\"./ui.date_box.base\");\n\nvar _uiDate_box2 = _interopRequireDefault(_uiDate_box);\n\nvar _number = require(\"../../localization/number\");\n\nvar _number2 = _interopRequireDefault(_number);\n\nvar _devices = require(\"../../core/devices\");\n\nvar _devices2 = _interopRequireDefault(_devices);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar MASK_EVENT_NAMESPACE = \"dateBoxMask\";\nvar FORWARD = 1;\nvar BACKWARD = -1;\n\nvar DateBoxMask = _uiDate_box2.default.inherit({\n  _supportedKeys: function (e) {\n    var _this = this;\n\n    var originalHandlers = this.callBase(e);\n\n    var callOriginalHandler = function (e) {\n      var originalHandler = originalHandlers[(0, _utils.normalizeKeyName)(e)];\n      return originalHandler && originalHandler.apply(_this, [e]);\n    };\n\n    var applyHandler = function (e, maskHandler) {\n      if (_this._shouldUseOriginalHandler(e)) {\n        return callOriginalHandler.apply(_this, [e]);\n      } else {\n        return maskHandler.apply(_this, [e]);\n      }\n    };\n\n    return (0, _extend.extend)({}, originalHandlers, {\n      del: function (e) {\n        return applyHandler(e, function (event) {\n          _this._revertPart(FORWARD);\n\n          _this._isAllSelected() || event.preventDefault();\n        });\n      },\n      backspace: function (e) {\n        return applyHandler(e, function (event) {\n          _this._revertPart(BACKWARD);\n\n          _this._isAllSelected() || event.preventDefault();\n        });\n      },\n      home: function (e) {\n        return applyHandler(e, function (event) {\n          _this._selectFirstPart();\n\n          event.preventDefault();\n        });\n      },\n      end: function (e) {\n        return applyHandler(e, function (event) {\n          _this._selectLastPart();\n\n          event.preventDefault();\n        });\n      },\n      escape: function (e) {\n        return applyHandler(e, function (event) {\n          _this._revertChanges(event);\n        });\n      },\n      enter: function (e) {\n        return applyHandler(e, function (event) {\n          _this._enterHandler(event);\n        });\n      },\n      leftArrow: function (e) {\n        return applyHandler(e, function (event) {\n          _this._selectNextPart(BACKWARD);\n\n          event.preventDefault();\n        });\n      },\n      rightArrow: function (e) {\n        return applyHandler(e, function (event) {\n          _this._selectNextPart(FORWARD);\n\n          event.preventDefault();\n        });\n      },\n      upArrow: function (e) {\n        return applyHandler(e, function (event) {\n          _this._upDownArrowHandler(FORWARD);\n\n          event.preventDefault();\n        });\n      },\n      downArrow: function (e) {\n        return applyHandler(e, function (event) {\n          _this._upDownArrowHandler(BACKWARD);\n\n          event.preventDefault();\n        });\n      }\n    });\n  },\n  _shouldUseOriginalHandler: function (e) {\n    var keysToHandleByMask = [\"backspace\", \"del\"];\n    var isNotDeletingInCalendar = this.option(\"opened\") && e && keysToHandleByMask.indexOf((0, _utils.normalizeKeyName)(e)) === -1;\n    return !this._useMaskBehavior() || isNotDeletingInCalendar || e && e.altKey;\n  },\n  _upDownArrowHandler: function (step) {\n    this._setNewDateIfEmpty();\n\n    var originalValue = this._getActivePartValue(this._initialMaskValue);\n\n    var currentValue = this._getActivePartValue();\n\n    var delta = currentValue - originalValue;\n\n    this._loadMaskValue(this._initialMaskValue);\n\n    this._partIncrease(delta + step, true);\n  },\n  _getDefaultOptions: function () {\n    return (0, _extend.extend)(this.callBase(), {\n      useMaskBehavior: false,\n      emptyDateValue: new Date(2e3, 0, 1, 0, 0, 0)\n    });\n  },\n  _isSingleCharKey: function (e) {\n    var key = e.originalEvent.data || e.originalEvent.key;\n    return \"string\" === typeof key && 1 === key.length && !e.ctrl && !e.alt;\n  },\n  _useBeforeInputEvent: function () {\n    var device = _devices2.default.real();\n\n    return device.android && device.version[0] > 4;\n  },\n  _keyboardHandler: function (e) {\n    var key = e.originalEvent.key;\n    var result = this.callBase(e);\n\n    if (!this._useMaskBehavior() || this._useBeforeInputEvent() || !this._isSingleCharKey(e)) {\n      return result;\n    }\n\n    this._processInputKey(key);\n\n    e.originalEvent.preventDefault();\n    return result;\n  },\n  _maskBeforeInputHandler: function (e) {\n    var _this2 = this;\n\n    this._maskInputHandler = null;\n    var inputType = e.originalEvent.inputType;\n\n    if (\"insertCompositionText\" === inputType) {\n      this._maskInputHandler = function () {\n        _this2._renderDisplayText(_this2._getDisplayedText(_this2._maskValue));\n\n        _this2._selectNextPart();\n      };\n    }\n\n    var isBackwardDeletion = \"deleteContentBackward\" === inputType;\n    var isForwardDeletion = \"deleteContentForward\" === inputType;\n\n    if (isBackwardDeletion || isForwardDeletion) {\n      var direction = isBackwardDeletion ? BACKWARD : FORWARD;\n\n      this._maskInputHandler = function () {\n        _this2._revertPart();\n\n        _this2._selectNextPart(direction);\n      };\n    }\n\n    if (!this._useMaskBehavior() || !this._isSingleCharKey(e)) {\n      return;\n    }\n\n    var key = e.originalEvent.data;\n\n    this._processInputKey(key);\n\n    e.preventDefault();\n    return true;\n  },\n  _keyPressHandler: function (e) {\n    this.callBase(e);\n\n    if (this._maskInputHandler) {\n      this._maskInputHandler();\n\n      this._maskInputHandler = null;\n    }\n  },\n  _processInputKey: function (key) {\n    if (this._isAllSelected()) {\n      this._activePartIndex = 0;\n    }\n\n    this._setNewDateIfEmpty();\n\n    if (isNaN(parseInt(key))) {\n      this._searchString(key);\n    } else {\n      this._searchNumber(key);\n    }\n  },\n  _isAllSelected: function () {\n    var caret = this._caret();\n\n    return caret.end - caret.start === this.option(\"text\").length;\n  },\n  _getFormatPattern: function () {\n    if (this._formatPattern) {\n      return this._formatPattern;\n    }\n\n    var format = this._strategy.getDisplayFormat(this.option(\"displayFormat\"));\n\n    var isLDMLPattern = (0, _type.isString)(format) && !_date2.default._getPatternByFormat(format);\n\n    if (isLDMLPattern) {\n      this._formatPattern = format;\n    } else {\n      this._formatPattern = (0, _date4.getFormat)(function (value) {\n        return _date2.default.format(value, format);\n      });\n    }\n\n    return this._formatPattern;\n  },\n  _setNewDateIfEmpty: function () {\n    if (!this._maskValue) {\n      var value = \"time\" === this.option(\"type\") ? new Date(null) : new Date();\n      this._maskValue = value;\n      this._initialMaskValue = value;\n\n      this._renderDateParts();\n    }\n  },\n  _partLimitsReached: function (max) {\n    var maxLimitLength = String(max).length;\n\n    var formatLength = this._getActivePartProp(\"pattern\").length;\n\n    var isShortFormat = 1 === formatLength;\n    var maxSearchLength = isShortFormat ? maxLimitLength : Math.min(formatLength, maxLimitLength);\n    var isLengthExceeded = this._searchValue.length === maxSearchLength;\n    var isValueOverflowed = parseInt(this._searchValue + \"0\") > max;\n    return isLengthExceeded || isValueOverflowed;\n  },\n  _searchNumber: function (char) {\n    var _this$_getActivePartL = this._getActivePartLimits(),\n        max = _this$_getActivePartL.max;\n\n    var maxLimitLength = String(max).length;\n    this._searchValue = (this._searchValue + char).substr(-maxLimitLength);\n\n    if (isNaN(this._searchValue)) {\n      this._searchValue = char;\n    }\n\n    this._setActivePartValue(this._searchValue);\n\n    if (this._partLimitsReached(max)) {\n      this._selectNextPart(FORWARD);\n    }\n  },\n  _searchString: function (char) {\n    if (!isNaN(parseInt(this._getActivePartProp(\"text\")))) {\n      return;\n    }\n\n    var limits = this._getActivePartProp(\"limits\")(this._maskValue);\n\n    var startString = this._searchValue + char.toLowerCase();\n    var endLimit = limits.max - limits.min;\n\n    for (var i = 0; i <= endLimit; i++) {\n      this._loadMaskValue(this._initialMaskValue);\n\n      this._partIncrease(i + 1);\n\n      if (0 === this._getActivePartProp(\"text\").toLowerCase().indexOf(startString)) {\n        this._searchValue = startString;\n        return;\n      }\n    }\n\n    this._setNewDateIfEmpty();\n\n    if (this._searchValue) {\n      this._clearSearchValue();\n\n      this._searchString(char);\n    }\n  },\n  _clearSearchValue: function () {\n    this._searchValue = \"\";\n  },\n  _revertPart: function (direction) {\n    if (!this._isAllSelected()) {\n      var actual = this._getActivePartValue(this.option(\"emptyDateValue\"));\n\n      this._setActivePartValue(actual);\n\n      this._selectNextPart(direction);\n    }\n\n    this._clearSearchValue();\n  },\n  _useMaskBehavior: function () {\n    return this.option(\"useMaskBehavior\") && \"text\" === this.option(\"mode\");\n  },\n  _prepareRegExpInfo: function () {\n    this._regExpInfo = (0, _date3.getRegExpInfo)(this._getFormatPattern(), _date2.default);\n    var regExp = this._regExpInfo.regexp;\n    var flags = regExp.flags;\n\n    var convertedRegExp = _number2.default.convertDigits(this._regExpInfo.regexp.source, false);\n\n    this._regExpInfo.regexp = RegExp(convertedRegExp, flags);\n  },\n  _initMaskState: function () {\n    this._activePartIndex = 0;\n    this._formatPattern = null;\n\n    this._prepareRegExpInfo();\n\n    this._loadMaskValue();\n  },\n  _renderMask: function () {\n    this.callBase();\n\n    this._detachMaskEvents();\n\n    this._clearMaskState();\n\n    if (this._useMaskBehavior()) {\n      this._attachMaskEvents();\n\n      this._initMaskState();\n\n      this._renderDateParts();\n    }\n  },\n  _renderDateParts: function () {\n    if (!this._useMaskBehavior()) {\n      return;\n    }\n\n    var text = this.option(\"text\") || this._getDisplayedText(this._maskValue);\n\n    if (text) {\n      this._dateParts = (0, _uiDate_boxMask.renderDateParts)(text, this._regExpInfo);\n      this._isFocused() && this._selectNextPart();\n    }\n  },\n  _detachMaskEvents: function () {\n    _events_engine2.default.off(this._input(), \".\" + MASK_EVENT_NAMESPACE);\n  },\n  _attachMaskEvents: function () {\n    var _this3 = this;\n\n    _events_engine2.default.on(this._input(), (0, _utils.addNamespace)(\"dxclick\", MASK_EVENT_NAMESPACE), this._maskClickHandler.bind(this));\n\n    _events_engine2.default.on(this._input(), (0, _utils.addNamespace)(\"paste\", MASK_EVENT_NAMESPACE), this._maskPasteHandler.bind(this));\n\n    _events_engine2.default.on(this._input(), (0, _utils.addNamespace)(\"drop\", MASK_EVENT_NAMESPACE), function () {\n      _this3._renderDisplayText(_this3._getDisplayedText(_this3._maskValue));\n\n      _this3._selectNextPart();\n    });\n\n    if (this._useBeforeInputEvent()) {\n      _events_engine2.default.on(this._input(), (0, _utils.addNamespace)(\"beforeinput\", MASK_EVENT_NAMESPACE), this._maskBeforeInputHandler.bind(this));\n    }\n  },\n  _selectLastPart: function () {\n    if (this.option(\"text\")) {\n      this._activePartIndex = this._dateParts.length;\n\n      this._selectNextPart(BACKWARD);\n    }\n  },\n  _selectFirstPart: function () {\n    if (this.option(\"text\")) {\n      this._activePartIndex = -1;\n\n      this._selectNextPart(FORWARD);\n    }\n  },\n  _onMouseWheel: function (e) {\n    if (this._useMaskBehavior()) {\n      this._partIncrease(e.delta > 0 ? FORWARD : BACKWARD, e);\n    }\n  },\n  _selectNextPart: function () {\n    var step = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : 0;\n\n    if (!this.option(\"text\") || this._disposed) {\n      return;\n    }\n\n    if (step) {\n      this._initialMaskValue = new Date(this._maskValue);\n    }\n\n    var index = (0, _math.fitIntoRange)(this._activePartIndex + step, 0, this._dateParts.length - 1);\n\n    if (this._dateParts[index].isStub) {\n      var isBoundaryIndex = 0 === index && step < 0 || index === this._dateParts.length - 1 && step > 0;\n\n      if (!isBoundaryIndex) {\n        this._selectNextPart(step >= 0 ? step + 1 : step - 1);\n\n        return;\n      } else {\n        index = this._activePartIndex;\n      }\n    }\n\n    if (this._activePartIndex !== index) {\n      this._clearSearchValue();\n    }\n\n    this._activePartIndex = index;\n\n    this._caret(this._getActivePartProp(\"caret\"));\n  },\n  _getRealLimitsPattern: function () {\n    if (\"d\" === this._getActivePartProp(\"pattern\")[0]) {\n      return \"dM\";\n    }\n  },\n  _getActivePartLimits: function (lockOtherParts) {\n    var limitFunction = this._getActivePartProp(\"limits\");\n\n    return limitFunction(this._maskValue, lockOtherParts && this._getRealLimitsPattern());\n  },\n  _getActivePartValue: function (dateValue) {\n    dateValue = dateValue || this._maskValue;\n\n    var getter = this._getActivePartProp(\"getter\");\n\n    return (0, _type.isFunction)(getter) ? getter(dateValue) : dateValue[getter]();\n  },\n  _addLeadingZeroes: function (value) {\n    var zeroes = this._searchValue.match(/^0+/);\n\n    var limits = this._getActivePartLimits();\n\n    var maxLimitLength = String(limits.max).length;\n    return ((zeroes && zeroes[0] || \"\") + String(value)).substr(-maxLimitLength);\n  },\n  _setActivePartValue: function (value, dateValue) {\n    dateValue = dateValue || this._maskValue;\n\n    var setter = this._getActivePartProp(\"setter\");\n\n    var limits = this._getActivePartLimits();\n\n    value = (0, _math.inRange)(value, limits.min, limits.max) ? value : value % 10;\n    value = this._addLeadingZeroes((0, _math.fitIntoRange)(value, limits.min, limits.max));\n    (0, _type.isFunction)(setter) ? setter(dateValue, value) : dateValue[setter](value);\n\n    this._renderDisplayText(this._getDisplayedText(dateValue));\n\n    this._renderDateParts();\n  },\n  _getActivePartProp: function (property) {\n    if (!this._dateParts || !this._dateParts[this._activePartIndex]) {\n      return;\n    }\n\n    return this._dateParts[this._activePartIndex][property];\n  },\n  _loadMaskValue: function () {\n    var value = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : this.dateOption(\"value\");\n    this._maskValue = value && new Date(value);\n    this._initialMaskValue = value && new Date(value);\n  },\n  _saveMaskValue: function () {\n    var value = this._maskValue && new Date(this._maskValue);\n\n    if (value && \"date\" === this.option(\"type\")) {\n      value.setHours(0, 0, 0, 0);\n    }\n\n    this._initialMaskValue = new Date(value);\n    this.dateOption(\"value\", value);\n  },\n  _revertChanges: function () {\n    this._loadMaskValue();\n\n    this._renderDisplayText(this._getDisplayedText(this._maskValue));\n\n    this._renderDateParts();\n  },\n  _renderDisplayText: function (text) {\n    this.callBase(text);\n\n    if (this._useMaskBehavior()) {\n      this.option(\"text\", text);\n    }\n  },\n  _partIncrease: function (step, lockOtherParts) {\n    this._setNewDateIfEmpty();\n\n    var _this$_getActivePartL2 = this._getActivePartLimits(lockOtherParts),\n        max = _this$_getActivePartL2.max,\n        min = _this$_getActivePartL2.min;\n\n    var limitDelta = max - min;\n\n    if (1 === limitDelta) {\n      limitDelta++;\n    }\n\n    var newValue = step + this._getActivePartValue();\n\n    if (newValue > max) {\n      newValue = this._applyLimits(newValue, {\n        limitBase: min,\n        limitClosest: max,\n        limitDelta: limitDelta\n      });\n    } else {\n      if (newValue < min) {\n        newValue = this._applyLimits(newValue, {\n          limitBase: max,\n          limitClosest: min,\n          limitDelta: limitDelta\n        });\n      }\n    }\n\n    this._setActivePartValue(newValue);\n  },\n  _applyLimits: function (newValue, _ref) {\n    var limitBase = _ref.limitBase,\n        limitClosest = _ref.limitClosest,\n        limitDelta = _ref.limitDelta;\n    var delta = (newValue - limitClosest) % limitDelta;\n    return delta ? limitBase + delta - 1 * (0, _math.sign)(delta) : limitClosest;\n  },\n  _maskClickHandler: function () {\n    if (this.option(\"text\")) {\n      this._activePartIndex = (0, _uiDate_boxMask.getDatePartIndexByPosition)(this._dateParts, this._caret().start);\n\n      this._caret(this._getActivePartProp(\"caret\"));\n    }\n  },\n  _maskPasteHandler: function (e) {\n    var newText = this._replaceSelectedText(this.option(\"text\"), this._caret(), (0, _dom.clipboardText)(e));\n\n    var date = _date2.default.parse(newText, this._getFormatPattern());\n\n    if (date) {\n      this._maskValue = date;\n\n      this._renderDisplayText(this._getDisplayedText(this._maskValue));\n\n      this._renderDateParts();\n\n      this._selectNextPart();\n    }\n\n    e.preventDefault();\n  },\n  _isValueDirty: function () {\n    var value = this.dateOption(\"value\");\n    return (this._maskValue && this._maskValue.getTime()) !== (value && value.getTime());\n  },\n  _fireChangeEvent: function () {\n    this._clearSearchValue();\n\n    if (this._isValueDirty()) {\n      _events_engine2.default.trigger(this._input(), \"change\");\n    }\n  },\n  _enterHandler: function (e) {\n    this._fireChangeEvent();\n\n    this._selectNextPart(FORWARD);\n\n    e.preventDefault();\n  },\n  _focusOutHandler: function (e) {\n    this.callBase(e);\n\n    if (this._useMaskBehavior() && !e.isDefaultPrevented()) {\n      this._fireChangeEvent();\n\n      this._selectFirstPart(e);\n    }\n  },\n  _valueChangeEventHandler: function (e) {\n    var text = this.option(\"text\");\n\n    if (this._useMaskBehavior()) {\n      this._saveValueChangeEvent(e);\n\n      if (!text) {\n        this._maskValue = null;\n      } else {\n        if (null === this._maskValue) {\n          this._loadMaskValue(text);\n        }\n      }\n\n      this._saveMaskValue();\n    } else {\n      this.callBase(e);\n    }\n  },\n  _optionChanged: function (args) {\n    switch (args.name) {\n      case \"useMaskBehavior\":\n        this._renderMask();\n\n        break;\n\n      case \"displayFormat\":\n      case \"mode\":\n        this.callBase(args);\n\n        this._renderMask();\n\n        break;\n\n      case \"value\":\n        this._loadMaskValue();\n\n        this.callBase(args);\n\n        this._renderDateParts();\n\n        break;\n\n      case \"emptyDateValue\":\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  },\n  _clearMaskState: function () {\n    this._clearSearchValue();\n\n    delete this._dateParts;\n    delete this._activePartIndex;\n    delete this._maskValue;\n  },\n  reset: function () {\n    this.callBase();\n\n    this._clearMaskState();\n\n    this._activePartIndex = 0;\n  },\n  _clean: function () {\n    this.callBase();\n\n    this._detachMaskEvents();\n\n    this._clearMaskState();\n  }\n});\n\nmodule.exports = DateBoxMask;","map":null,"metadata":{},"sourceType":"script"}