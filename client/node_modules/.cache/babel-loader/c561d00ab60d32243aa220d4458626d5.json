{"ast":null,"code":"/* tslint:disable-next-line:max-line-length */\nimport { EventHandler, isNullOrUndefined, extend, classList, addClass, removeClass, Browser, getValue, setValue, isBlazor } from '@syncfusion/ej2-base';\nimport { parentsUntil, getUid, appendChildren, getDatePredicate, getObject, extendObjWithFn, eventPromise } from '../base/util';\nimport { remove, debounce } from '@syncfusion/ej2-base';\nimport { DataUtil, Query, DataManager, Predicate } from '@syncfusion/ej2-data';\nimport { createCheckBox } from '@syncfusion/ej2-buttons';\nimport * as events from '../base/constant';\nimport { ValueFormatter } from '../services/value-formatter';\nimport { getForeignData } from '../base/util';\nimport { Dialog } from '@syncfusion/ej2-popups';\nimport { Input } from '@syncfusion/ej2-inputs';\nimport { createSpinner, hideSpinner, showSpinner } from '@syncfusion/ej2-popups';\nimport { getFilterMenuPostion, toogleCheckbox, createCboxWithWrap, removeAddCboxClasses, getColumnByForeignKeyValue } from '../base/util';\n/**\n * @hidden\n * `CheckBoxFilterBase` module is used to handle filtering action.\n */\n\nvar CheckBoxFilterBase =\n/** @class */\nfunction () {\n  /**\n   * Constructor for checkbox filtering module\n   * @hidden\n   */\n  function CheckBoxFilterBase(parent) {\n    this.existingPredicate = {};\n    this.foreignKeyQuery = new Query();\n    this.filterState = true;\n    this.values = {};\n    this.renderEmpty = false;\n    this.parent = parent;\n    this.id = this.parent.element.id;\n    this.valueFormatter = new ValueFormatter(this.parent.locale);\n    this.cBoxTrue = createCheckBox(this.parent.createElement, false, {\n      checked: true,\n      label: ' '\n    });\n    this.cBoxFalse = createCheckBox(this.parent.createElement, false, {\n      checked: false,\n      label: ' '\n    });\n    this.cBoxTrue.insertBefore(this.parent.createElement('input', {\n      className: 'e-chk-hidden',\n      attrs: {\n        type: 'checkbox'\n      }\n    }), this.cBoxTrue.firstChild);\n    this.cBoxFalse.insertBefore(this.parent.createElement('input', {\n      className: 'e-chk-hidden',\n      attrs: {\n        'type': 'checkbox'\n      }\n    }), this.cBoxFalse.firstChild);\n    this.cBoxFalse.querySelector('.e-frame').classList.add('e-uncheck');\n\n    if (this.parent.enableRtl) {\n      addClass([this.cBoxTrue, this.cBoxFalse], ['e-rtl']);\n    }\n  }\n  /**\n   * To destroy the filter bar.\n   * @return {void}\n   * @hidden\n   */\n\n\n  CheckBoxFilterBase.prototype.destroy = function () {\n    this.closeDialog();\n  };\n\n  CheckBoxFilterBase.prototype.wireEvents = function () {\n    EventHandler.add(this.dlg, 'click', this.clickHandler, this);\n    this.searchHandler = debounce(this.searchBoxKeyUp, 200);\n    EventHandler.add(this.dlg.querySelector('.e-searchinput'), 'keyup', this.searchHandler, this);\n  };\n\n  CheckBoxFilterBase.prototype.unWireEvents = function () {\n    EventHandler.remove(this.dlg, 'click', this.clickHandler);\n    var elem = this.dlg.querySelector('.e-searchinput');\n\n    if (elem) {\n      EventHandler.remove(elem, 'keyup', this.searchHandler);\n    }\n  };\n\n  CheckBoxFilterBase.prototype.foreignKeyFilter = function (args, fColl, mPredicate) {\n    var _this = this;\n\n    var fPredicate = {};\n    var filterCollection = [];\n    var query = this.foreignKeyQuery.clone();\n    this.options.column.dataSource.executeQuery(query.where(mPredicate)).then(function (e) {\n      _this.options.column.columnData = e.result;\n\n      _this.parent.notify(events.generateQuery, {\n        predicate: fPredicate,\n        column: _this.options.column\n      });\n\n      args.ejpredicate = fPredicate.predicate.predicates;\n      var fpred = fPredicate.predicate.predicates;\n\n      for (var i = 0; i < fpred.length; i++) {\n        filterCollection.push({\n          field: fpred[i].field,\n          predicate: 'or',\n          matchCase: fpred[i].ignoreCase,\n          ignoreAccent: fpred[i].ignoreAccent,\n          operator: fpred[i].operator,\n          value: fpred[i].value,\n          type: _this.options.type\n        });\n      }\n\n      args.filterCollection = filterCollection.length ? filterCollection : fColl.filter(function (col) {\n        return col.field = _this.options.field;\n      });\n\n      _this.options.handler(args);\n    });\n  };\n\n  CheckBoxFilterBase.prototype.foreignFilter = function (args, value) {\n    var operator = this.options.isRemote ? this.options.column.type === 'string' ? 'contains' : 'equal' : this.options.column.type ? 'contains' : 'equal';\n    var initalPredicate = new Predicate(this.options.column.foreignKeyValue, operator, value, true, this.options.ignoreAccent);\n    this.foreignKeyFilter(args, [args.filterCollection], initalPredicate);\n  };\n\n  CheckBoxFilterBase.prototype.searchBoxClick = function (e) {\n    var target = e.target;\n\n    if (target.classList.contains('e-searchclear')) {\n      this.sInput.value = '';\n      this.refreshCheckboxes();\n      this.updateSearchIcon();\n      this.sInput.focus();\n    }\n  };\n\n  CheckBoxFilterBase.prototype.searchBoxKeyUp = function (e) {\n    this.refreshCheckboxes();\n    this.updateSearchIcon();\n  };\n\n  CheckBoxFilterBase.prototype.updateSearchIcon = function () {\n    if (this.sInput.value.length) {\n      classList(this.sIcon, ['e-chkcancel-icon'], ['e-search-icon']);\n    } else {\n      classList(this.sIcon, ['e-search-icon'], ['e-chkcancel-icon']);\n    }\n  };\n  /**\n   * Gets the localized label by locale keyword.\n   * @param  {string} key\n   * @return {string}\n   */\n\n\n  CheckBoxFilterBase.prototype.getLocalizedLabel = function (key) {\n    return this.localeObj.getConstant(key);\n  };\n\n  CheckBoxFilterBase.prototype.updateDataSource = function () {\n    var dataSource = this.options.dataSource;\n    var str = 'object';\n\n    if (!(dataSource instanceof DataManager)) {\n      for (var i = 0; i < dataSource.length; i++) {\n        if (typeof dataSource !== str) {\n          var obj = {};\n          obj[this.options.field] = dataSource[i];\n          dataSource[i] = obj;\n        }\n      }\n    }\n  };\n\n  CheckBoxFilterBase.prototype.updateModel = function (options) {\n    this.options = options;\n    this.existingPredicate = options.actualPredicate || {};\n    this.options.dataSource = options.dataSource;\n    this.options.dataManager = options.dataManager ? options.dataManager : options.dataSource;\n    this.updateDataSource();\n    this.options.type = options.type;\n    this.options.format = options.format || '';\n    this.options.ignoreAccent = options.ignoreAccent || false;\n    this.options.filteredColumns = options.filteredColumns || this.parent.filterSettings.columns;\n    this.options.query = options.query || new Query();\n    this.options.allowCaseSensitive = options.allowCaseSensitive || false;\n    this.options.uid = options.column.uid;\n    this.values = {};\n    this.localeObj = options.localeObj;\n    this.isFiltered = options.filteredColumns.length;\n  };\n\n  CheckBoxFilterBase.prototype.getAndSetChkElem = function (options) {\n    this.dlg = this.parent.createElement('div', {\n      id: this.id + this.options.type + '_excelDlg',\n      className: 'e-checkboxfilter e-filter-popup'\n    });\n    this.sBox = this.parent.createElement('div', {\n      className: 'e-searchcontainer'\n    });\n\n    if (!options.hideSearchbox) {\n      this.sInput = this.parent.createElement('input', {\n        id: this.id + '_SearchBox',\n        className: 'e-searchinput'\n      });\n      this.sIcon = this.parent.createElement('span', {\n        className: 'e-searchclear e-search-icon e-icons e-input-group-icon',\n        attrs: {\n          type: 'text',\n          title: this.getLocalizedLabel('Search')\n        }\n      });\n      this.searchBox = this.parent.createElement('span', {\n        className: 'e-searchbox e-fields'\n      });\n      this.searchBox.appendChild(this.sInput);\n      this.sBox.appendChild(this.searchBox);\n      var inputargs = {\n        element: this.sInput,\n        floatLabelType: 'Never',\n        properties: {\n          placeholder: this.getLocalizedLabel('Search')\n        }\n      };\n      Input.createInput(inputargs, this.parent.createElement);\n      this.searchBox.querySelector('.e-input-group').appendChild(this.sIcon);\n    }\n\n    this.spinner = this.parent.createElement('div', {\n      className: 'e-spinner'\n    }); //for spinner\n\n    this.cBox = this.parent.createElement('div', {\n      id: this.id + this.options.type + '_CheckBoxList',\n      className: 'e-checkboxlist e-fields'\n    });\n    this.spinner.appendChild(this.cBox);\n    this.sBox.appendChild(this.spinner);\n    return this.sBox;\n  };\n\n  CheckBoxFilterBase.prototype.showDialog = function (options) {\n    var args = {\n      requestType: events.filterBeforeOpen,\n      columnName: this.options.field,\n      columnType: this.options.type,\n      cancel: false\n    };\n\n    if (!isBlazor() || this.parent.isJsComponent) {\n      var filterModel = 'filterModel';\n      args[filterModel] = this;\n    }\n\n    this.parent.notify(events.cBoxFltrBegin, args);\n\n    if (args.cancel) {\n      return;\n    }\n\n    this.dialogObj = new Dialog({\n      visible: false,\n      content: this.sBox,\n      close: this.closeDialog.bind(this),\n      width: !isNullOrUndefined(parentsUntil(options.target, 'e-bigger')) || this.parent.element.classList.contains('e-device') ? 260 : 255,\n      target: this.parent.element,\n      animationSettings: {\n        effect: 'None'\n      },\n      buttons: [{\n        click: this.btnClick.bind(this),\n        buttonModel: {\n          content: this.getLocalizedLabel(this.isExcel ? 'OKButton' : 'FilterButton'),\n          cssClass: 'e-primary',\n          isPrimary: true\n        }\n      }, {\n        click: this.btnClick.bind(this),\n        buttonModel: {\n          cssClass: 'e-flat',\n          content: this.getLocalizedLabel(this.isExcel ? 'CancelButton' : 'ClearButton')\n        }\n      }],\n      created: this.dialogCreated.bind(this),\n      open: this.dialogOpen.bind(this)\n    });\n    var isStringTemplate = 'isStringTemplate';\n    this.dialogObj[isStringTemplate] = true;\n    this.dlg.setAttribute('aria-label', this.getLocalizedLabel('ExcelFilterDialogARIA'));\n    this.parent.element.appendChild(this.dlg);\n    this.dialogObj.appendTo(this.dlg);\n    this.dialogObj.element.style.maxHeight = this.options.height + 'px';\n    this.dialogObj.show();\n    this.wireEvents();\n    createSpinner({\n      target: this.spinner\n    }, this.parent.createElement);\n    showSpinner(this.spinner);\n    this.getAllData();\n  };\n\n  CheckBoxFilterBase.prototype.dialogCreated = function (e) {\n    if (!Browser.isDevice) {\n      getFilterMenuPostion(this.options.target, this.dialogObj, this.parent);\n    } else {\n      this.dialogObj.position = {\n        X: 'center',\n        Y: 'center'\n      };\n    }\n\n    this.parent.notify(events.filterDialogCreated, e);\n  };\n\n  CheckBoxFilterBase.prototype.openDialog = function (options) {\n    this.updateModel(options);\n    this.getAndSetChkElem(options);\n    this.showDialog(options);\n  };\n\n  CheckBoxFilterBase.prototype.closeDialog = function () {\n    if (this.dialogObj && !this.dialogObj.isDestroyed) {\n      var filterTemplateCol = this.options.columns.filter(function (col) {\n        return col.getFilterItemTemplate();\n      }); // tslint:disable-next-line:no-any\n\n      var registeredTemplate = this.parent.registeredTemplate;\n\n      if (filterTemplateCol.length && !isNullOrUndefined(registeredTemplate) && registeredTemplate.filterItemTemplate) {\n        this.parent.destroyTemplate(['filterItemTemplate']);\n      }\n\n      this.parent.notify(events.filterMenuClose, {\n        field: this.options.field\n      });\n      this.dialogObj.destroy();\n      this.unWireEvents();\n      remove(this.dlg);\n      this.dlg = null;\n    }\n  };\n\n  CheckBoxFilterBase.prototype.clearFilter = function () {\n    /* tslint:disable-next-line:max-line-length */\n    var args = {\n      instance: this,\n      handler: this.clearFilter,\n      cancel: false\n    };\n    this.parent.notify(events.fltrPrevent, args);\n\n    if (args.cancel) {\n      return;\n    }\n\n    this.options.handler({\n      action: 'clear-filter',\n      field: this.options.field\n    });\n  };\n\n  CheckBoxFilterBase.prototype.btnClick = function (e) {\n    if (this.filterState) {\n      if (e.target.tagName.toLowerCase() === 'input' && e.target.classList.contains('e-searchinput')) {\n        var value = e.target.value;\n\n        if (this.options.column.type === 'boolean') {\n          if (value !== '' && this.getLocalizedLabel('FilterTrue').toLowerCase().indexOf(value.toLowerCase()) !== -1) {\n            value = true;\n          } else if (value !== '' && this.getLocalizedLabel('FilterFalse').toLowerCase().indexOf(value.toLowerCase()) !== -1) {\n            value = false;\n          }\n        }\n\n        var args = {\n          action: 'filtering',\n          filterCollection: {\n            field: this.options.field,\n            operator: this.options.isRemote ? this.options.column.type === 'string' ? 'contains' : 'equal' : this.options.column.type === 'date' || this.options.column.type === 'datetime' || this.options.column.type === 'boolean' ? 'equal' : 'contains',\n            value: value,\n            matchCase: false,\n            type: this.options.column.type\n          },\n          field: this.options.field\n        };\n        value !== undefined && value !== null && value !== '' ? this.isForeignColumn(this.options.column) ? this.foreignFilter(args, value) : this.options.handler(args) : this.closeDialog();\n      } else {\n        if (e.keyCode === 13) {\n          this.fltrBtnHandler();\n        } else {\n          var text = e.target.firstChild.textContent.toLowerCase();\n\n          if (this.getLocalizedLabel(this.isExcel ? 'OKButton' : 'FilterButton').toLowerCase() === text) {\n            this.fltrBtnHandler();\n          } else if (this.getLocalizedLabel('ClearButton').toLowerCase() === text) {\n            this.clearFilter();\n          }\n        }\n      }\n\n      this.closeDialog();\n    } else if (!(e.target.tagName.toLowerCase() === 'input')) {\n      this.clearFilter();\n      this.closeDialog();\n    }\n  };\n\n  CheckBoxFilterBase.prototype.fltrBtnHandler = function () {\n    var checked = [].slice.call(this.cBox.querySelectorAll('.e-check:not(.e-selectall)'));\n    var check = checked;\n    var optr = 'equal';\n    var searchInput = this.searchBox.querySelector('.e-searchinput');\n    var caseSen = this.options.allowCaseSensitive;\n    var defaults = {\n      field: this.options.field,\n      predicate: 'or',\n      uid: this.options.uid,\n      operator: optr,\n      type: this.options.type,\n      matchCase: caseSen,\n      ignoreAccent: this.options.ignoreAccent\n    };\n    var isNotEqual = this.itemsCnt !== checked.length && this.itemsCnt - checked.length < checked.length;\n\n    if (isNotEqual && searchInput.value === '') {\n      optr = 'notequal';\n      checked = [].slice.call(this.cBox.querySelectorAll('.e-uncheck:not(.e-selectall)'));\n      defaults.predicate = 'and';\n      defaults.operator = 'notequal';\n    }\n\n    var value;\n    var val;\n    var length;\n    var fObj;\n    var coll = [];\n\n    if (checked.length !== this.itemsCnt || searchInput.value && searchInput.value !== '') {\n      for (var i = 0; i < checked.length; i++) {\n        value = this.values[parentsUntil(checked[i], 'e-ftrchk').getAttribute('uid')];\n        fObj = extend({}, {\n          value: value\n        }, defaults);\n\n        if (value && !value.toString().length) {\n          fObj.operator = isNotEqual ? 'notequal' : 'equal';\n        }\n\n        if (value === '' || isNullOrUndefined(value)) {\n          if (this.options.type === 'string') {\n            coll.push({\n              field: defaults.field,\n              ignoreAccent: defaults.ignoreAccent,\n              matchCase: defaults.matchCase,\n              operator: defaults.operator,\n              predicate: defaults.predicate,\n              value: ''\n            });\n          }\n\n          coll.push({\n            field: defaults.field,\n            matchCase: defaults.matchCase,\n            operator: defaults.operator,\n            predicate: defaults.predicate,\n            value: null\n          });\n          coll.push({\n            field: defaults.field,\n            matchCase: defaults.matchCase,\n            operator: defaults.operator,\n            predicate: defaults.predicate,\n            value: undefined\n          });\n        } else {\n          coll.push(fObj);\n        }\n\n        var args = {\n          instance: this,\n          handler: this.fltrBtnHandler,\n          arg1: fObj.field,\n          arg2: fObj.predicate,\n          arg3: fObj.operator,\n          arg4: fObj.matchCase,\n          arg5: fObj.ignoreAccent,\n          arg6: fObj.value,\n          cancel: false\n        };\n        this.parent.notify(events.fltrPrevent, args);\n\n        if (args.cancel) {\n          return;\n        }\n      }\n\n      if (this.options.type === 'date' || this.options.type === 'datetime') {\n        length = check.length - 1;\n        val = this.values[parentsUntil(check[length], 'e-ftrchk').getAttribute('uid')];\n\n        if (isNullOrUndefined(val) && isNotEqual) {\n          coll.push({\n            field: defaults.field,\n            matchCase: defaults.matchCase,\n            operator: 'equal',\n            predicate: 'and',\n            value: null\n          });\n        }\n      }\n\n      this.initiateFilter(coll);\n    } else {\n      this.clearFilter();\n    }\n  };\n\n  CheckBoxFilterBase.prototype.initiateFilter = function (fColl) {\n    var firstVal = fColl[0];\n    var predicate;\n\n    if (!isNullOrUndefined(firstVal)) {\n      predicate = firstVal.ejpredicate ? firstVal.ejpredicate : new Predicate(firstVal.field, firstVal.operator, firstVal.value, !firstVal.matchCase, firstVal.ignoreAccent);\n\n      for (var j = 1; j < fColl.length; j++) {\n        predicate = fColl[j].ejpredicate !== undefined ? predicate[fColl[j].predicate](fColl[j].ejpredicate) : predicate[fColl[j].predicate](fColl[j].field, fColl[j].operator, fColl[j].value, !fColl[j].matchCase, fColl[j].ignoreAccent);\n      }\n\n      var args = {\n        action: 'filtering',\n        filterCollection: fColl,\n        field: this.options.field,\n        ejpredicate: Predicate.or(predicate)\n      };\n      this.options.handler(args);\n    }\n  };\n\n  CheckBoxFilterBase.prototype.isForeignColumn = function (col) {\n    return col.isForeignColumn ? col.isForeignColumn() : false;\n  };\n\n  CheckBoxFilterBase.prototype.refreshCheckboxes = function () {\n    var _this = this;\n\n    var val = this.sInput.value;\n    var column = this.options.column;\n    var query = this.isForeignColumn(column) ? this.foreignKeyQuery.clone() : this.options.query.clone();\n    var foreignQuery = this.options.query.clone();\n    var pred = query.queries.filter(function (e) {\n      return e && e.fn === 'onWhere';\n    })[0];\n    query.queries = [];\n    foreignQuery.queries = [];\n    var parsed = this.options.type !== 'string' && parseFloat(val) ? parseFloat(val) : val;\n    var operator = this.options.isRemote ? this.options.type === 'string' ? 'contains' : 'equal' : this.options.type ? 'contains' : 'equal';\n    var matchCase = true;\n    var ignoreAccent = this.options.ignoreAccent;\n    var field = this.isForeignColumn(column) ? column.foreignKeyValue : column.field;\n    parsed = parsed === '' || parsed === undefined ? undefined : parsed;\n    var predicte;\n    var moduleName = this.options.dataManager.adaptor.getModuleName;\n\n    if (this.options.type === 'boolean') {\n      if (parsed !== undefined && this.getLocalizedLabel('FilterTrue').toLowerCase().indexOf(parsed.toLowerCase()) !== -1 && moduleName) {\n        parsed = moduleName() === 'ODataAdaptor' || 'ODataV4Adaptor' ? true : 'true';\n      } else if (parsed !== undefined && this.getLocalizedLabel('FilterFalse').toLowerCase().indexOf(parsed.toLowerCase()) !== -1 && moduleName) {\n        parsed = moduleName() === 'ODataAdaptor' || 'ODataV4Adaptor' ? false : 'false';\n      }\n\n      operator = 'equal';\n    }\n\n    if (this.options.type === 'date' || this.options.type === 'datetime') {\n      parsed = this.valueFormatter.fromView(val, this.options.parserFn, this.options.type);\n    }\n\n    this.addDistinct(query);\n    /* tslint:disable-next-line:max-line-length */\n\n    var args = {\n      requestType: events.filterSearchBegin,\n      filterModel: this,\n      columnName: field,\n      column: column,\n      operator: operator,\n      matchCase: matchCase,\n      ignoreAccent: ignoreAccent,\n      filterChoiceCount: null,\n      query: query,\n      value: parsed\n    };\n\n    if (isBlazor() && !this.parent.isJsComponent) {\n      var filterModel = 'filterModel';\n      args[filterModel] = {};\n    }\n\n    this.parent.trigger(events.actionBegin, args, function (filterargs) {\n      filterargs.operator = isBlazor() && filterargs.excelSearchOperator !== 'none' ? filterargs.excelSearchOperator : filterargs.operator;\n      predicte = new Predicate(field, filterargs.operator, parsed, filterargs.matchCase, filterargs.ignoreAccent);\n\n      if (_this.options.type === 'date' || _this.options.type === 'datetime') {\n        operator = 'equal';\n\n        if (isNullOrUndefined(parsed) && val.length) {\n          return;\n        }\n\n        var filterObj = {\n          field: field,\n          operator: operator,\n          value: parsed,\n          matchCase: matchCase,\n          ignoreAccent: ignoreAccent\n        };\n        predicte = getDatePredicate(filterObj, _this.options.type);\n      }\n\n      if (val.length) {\n        predicte = !isNullOrUndefined(pred) ? predicte.and(pred.e) : predicte;\n        query.where(predicte);\n      } else if (!isNullOrUndefined(pred)) {\n        query.where(pred.e);\n      }\n\n      filterargs.filterChoiceCount = !isNullOrUndefined(filterargs.filterChoiceCount) ? filterargs.filterChoiceCount : 1000;\n      var fPredicate = {};\n      showSpinner(_this.spinner);\n      _this.renderEmpty = false;\n\n      if (_this.isForeignColumn(column) && val.length) {\n        var colData = 'result' in column.dataSource ? new DataManager(column.dataSource.result) : column.dataSource; // tslint:disable-next-line:no-any\n\n        colData.executeQuery(query).then(function (e) {\n          var columnData = _this.options.column.columnData;\n          _this.options.column.columnData = e.result;\n\n          _this.parent.notify(events.generateQuery, {\n            predicate: fPredicate,\n            column: column\n          });\n\n          if (fPredicate.predicate.predicates.length) {\n            foreignQuery.where(fPredicate.predicate);\n          } else {\n            _this.renderEmpty = true;\n          }\n\n          _this.options.column.columnData = columnData;\n          foreignQuery.take(filterargs.filterChoiceCount);\n\n          _this.search(filterargs, foreignQuery);\n        });\n      } else {\n        query.take(filterargs.filterChoiceCount);\n\n        _this.search(filterargs, query);\n      }\n    });\n  };\n\n  CheckBoxFilterBase.prototype.search = function (args, query) {\n    if (this.parent.dataSource && 'result' in this.parent.dataSource) {\n      this.filterEvent(args, query);\n    } else {\n      this.processSearch(query);\n    }\n  };\n\n  CheckBoxFilterBase.prototype.getPredicateFromCols = function (columns) {\n    var predicates = CheckBoxFilterBase.getPredicate(columns);\n    var predicateList = [];\n    var fPredicate = {};\n    var isGrid = this.parent.getForeignKeyColumns !== undefined;\n    var foreignColumn = isGrid ? this.parent.getForeignKeyColumns() : [];\n\n    for (var _i = 0, _a = Object.keys(predicates); _i < _a.length; _i++) {\n      var prop = _a[_i];\n      var col = void 0;\n\n      if (isGrid && this.parent.getColumnByField(prop).isForeignColumn()) {\n        col = getColumnByForeignKeyValue(prop, foreignColumn);\n      }\n\n      if (col) {\n        this.parent.notify(events.generateQuery, {\n          predicate: fPredicate,\n          column: col\n        });\n\n        if (fPredicate.predicate.predicates.length) {\n          predicateList.push(Predicate.or(fPredicate.predicate.predicates));\n        }\n      } else {\n        predicateList.push(predicates[prop]);\n      }\n    }\n\n    return predicateList.length && Predicate.and(predicateList);\n  };\n\n  CheckBoxFilterBase.prototype.getQuery = function () {\n    return this.parent.getQuery ? this.parent.getQuery().clone() : new Query();\n  };\n\n  CheckBoxFilterBase.prototype.getAllData = function () {\n    var _this = this;\n\n    var query = this.getQuery();\n    query.requiresCount(); //consider take query\n\n    this.addDistinct(query);\n    var args = {\n      requestType: events.filterChoiceRequest,\n      query: query,\n      filterChoiceCount: null\n    };\n\n    if (!isBlazor() || this.parent.isJsComponent) {\n      var filterModel = 'filterModel';\n      args[filterModel] = this;\n    }\n\n    this.parent.trigger(events.actionBegin, args, function (args) {\n      args.filterChoiceCount = !isNullOrUndefined(args.filterChoiceCount) ? args.filterChoiceCount : 1000;\n      query.take(args.filterChoiceCount);\n\n      if (_this.parent.dataSource && 'result' in _this.parent.dataSource) {\n        _this.filterEvent(args, query);\n      } else {\n        _this.processDataOperation(query, true);\n      }\n    });\n  };\n\n  CheckBoxFilterBase.prototype.addDistinct = function (query) {\n    var filteredColumn = DataUtil.distinct(this.options.filteredColumns, 'field');\n\n    if (filteredColumn.indexOf(this.options.column.field) <= -1) {\n      filteredColumn = filteredColumn.concat(this.options.column.field);\n    }\n\n    query.distinct(filteredColumn);\n    return query;\n  };\n\n  CheckBoxFilterBase.prototype.filterEvent = function (args, query) {\n    var _this = this;\n\n    var defObj = eventPromise(args, query);\n    this.parent.trigger(events.dataStateChange, defObj.state);\n    var def = defObj.deffered;\n    def.promise.then(function (e) {\n      _this.dataSuccess(e);\n    });\n  };\n\n  CheckBoxFilterBase.prototype.processDataOperation = function (query, isInitial) {\n    var _this = this;\n\n    this.options.dataSource = this.options.dataSource instanceof DataManager ? this.options.dataSource : new DataManager(this.options.dataSource);\n    var allPromise = [];\n    var runArray = [];\n\n    if (this.isForeignColumn(this.options.column) && isInitial) {\n      var colData = 'result' in this.options.column.dataSource ? new DataManager(this.options.column.dataSource.result) : this.options.column.dataSource;\n      this.foreignKeyQuery.params = query.params;\n      allPromise.push(colData.executeQuery(this.foreignKeyQuery));\n      runArray.push(function (data) {\n        return _this.foreignKeyData = data;\n      });\n    }\n\n    allPromise.push(this.options.dataSource.executeQuery(query));\n    runArray.push(this.dataSuccess.bind(this));\n    var i = 0;\n    Promise.all(allPromise).then(function (e) {\n      for (var j = 0; j < e.length; j++) {\n        runArray[i++](e[j].result);\n      }\n    });\n  };\n\n  CheckBoxFilterBase.prototype.dataSuccess = function (e) {\n    this.fullData = e;\n    var query = new Query();\n\n    if (this.parent.searchSettings && this.parent.searchSettings.key.length) {\n      var sSettings = this.parent.searchSettings;\n      var fields = sSettings.fields.length ? sSettings.fields : this.options.columns.map(function (f) {\n        return f.field;\n      });\n      /* tslint:disable-next-line:max-line-length */\n\n      query.search(sSettings.key, fields, sSettings.operator, sSettings.ignoreCase, sSettings.ignoreAccent);\n    }\n\n    if (this.options.filteredColumns.length) {\n      var cols = [];\n\n      for (var i = 0; i < this.options.filteredColumns.length; i++) {\n        var filterColumn = this.options.filteredColumns[i];\n\n        if (this.options.uid) {\n          filterColumn.uid = filterColumn.uid || this.parent.getColumnByField(filterColumn.field).uid;\n\n          if (filterColumn.uid !== this.options.uid) {\n            cols.push(this.options.filteredColumns[i]);\n          }\n        } else {\n          if (filterColumn.field !== this.options.field) {\n            cols.push(this.options.filteredColumns[i]);\n          }\n        }\n      }\n\n      var predicate = this.getPredicateFromCols(cols);\n\n      if (predicate) {\n        query.where(predicate);\n      }\n    } // query.select(this.options.field);\n\n\n    var result = new DataManager(this.fullData).executeLocal(query);\n    var col = this.options.column;\n    this.filteredData = CheckBoxFilterBase.getDistinct(result, this.options.field, col, this.foreignKeyData).records || [];\n    this.processDataSource(null, true, this.filteredData);\n    this.sInput.focus();\n    var args = {\n      requestType: events.filterAfterOpen,\n      columnName: this.options.field,\n      columnType: this.options.type\n    };\n\n    if (!isBlazor() || this.parent.isJsComponent) {\n      var filterModel = 'filterModel';\n      args[filterModel] = this;\n    }\n\n    this.parent.notify(events.cBoxFltrComplete, args);\n  };\n\n  CheckBoxFilterBase.prototype.processDataSource = function (query, isInitial, dataSource) {\n    showSpinner(this.spinner); // query = query ? query : this.options.query.clone();\n    // query.requiresCount();\n    // let result: Object = new DataManager(dataSource as JSON[]).executeLocal(query);\n    // let res: { result: Object[] } = result as { result: Object[] };\n\n    this.updateResult();\n    this.createFilterItems(dataSource, isInitial);\n  };\n\n  CheckBoxFilterBase.prototype.processSearch = function (query) {\n    this.processDataOperation(query);\n  };\n\n  CheckBoxFilterBase.prototype.updateResult = function () {\n    this.result = {};\n    var predicate = this.getPredicateFromCols(this.options.filteredColumns);\n    var query = new Query();\n\n    if (predicate) {\n      query.where(predicate);\n    }\n\n    var result = new DataManager(this.fullData).executeLocal(query);\n\n    for (var _i = 0, result_1 = result; _i < result_1.length; _i++) {\n      var res = result_1[_i];\n      this.result[getObject(this.options.field, res)] = true;\n    }\n  };\n\n  CheckBoxFilterBase.prototype.clickHandler = function (e) {\n    var target = e.target;\n    var elem = parentsUntil(target, 'e-checkbox-wrapper');\n\n    if (parentsUntil(target, 'e-searchbox')) {\n      this.searchBoxClick(e);\n    }\n\n    if (elem) {\n      var selectAll = elem.querySelector('.e-selectall');\n\n      if (selectAll) {\n        this.updateAllCBoxes(!selectAll.classList.contains('e-check'));\n      } else {\n        toogleCheckbox(elem.parentElement);\n      }\n\n      this.updateIndeterminatenBtn();\n      elem.querySelector('.e-chk-hidden').focus();\n    }\n  };\n\n  CheckBoxFilterBase.prototype.updateAllCBoxes = function (checked) {\n    var cBoxes = [].slice.call(this.cBox.querySelectorAll('.e-frame'));\n\n    for (var _i = 0, cBoxes_1 = cBoxes; _i < cBoxes_1.length; _i++) {\n      var cBox = cBoxes_1[_i];\n      removeAddCboxClasses(cBox, checked);\n    }\n  };\n\n  CheckBoxFilterBase.prototype.dialogOpen = function () {\n    if (this.parent.element.classList.contains('e-device')) {\n      this.dialogObj.element.querySelector('.e-input-group').classList.remove('e-input-focus');\n      this.dialogObj.element.querySelector('.e-btn').focus();\n    }\n  };\n\n  CheckBoxFilterBase.prototype.createCheckbox = function (value, checked, data) {\n    var elem = checked ? this.cBoxTrue.cloneNode(true) : this.cBoxFalse.cloneNode(true);\n    var label = elem.querySelector('.e-label');\n    var dummyData = extendObjWithFn({}, data, {\n      column: this.options.column,\n      parent: this.parent\n    });\n    label.innerHTML = !isNullOrUndefined(value) && value.toString().length ? value : this.getLocalizedLabel('Blanks');\n    addClass([label], ['e-checkboxfiltertext']);\n\n    if (this.options.template && data[this.options.column.field] !== this.getLocalizedLabel('SelectAll')) {\n      label.innerHTML = '';\n      appendChildren(label, this.options.template(dummyData, this.parent, 'filterItemTemplate'));\n    }\n\n    return elem;\n  };\n\n  CheckBoxFilterBase.prototype.updateIndeterminatenBtn = function () {\n    var cnt = this.cBox.children.length - 1;\n    var className = [];\n    var elem = this.cBox.querySelector('.e-selectall');\n    var selected = this.cBox.querySelectorAll('.e-check:not(.e-selectall)').length;\n    var btn = this.dialogObj.btnObj[0];\n    btn.disabled = false;\n\n    if (cnt === selected) {\n      className = ['e-check'];\n    } else if (selected) {\n      className = ['e-stop'];\n    } else {\n      className = ['e-uncheck'];\n      btn.disabled = true;\n    }\n\n    this.filterState = !btn.disabled;\n    btn.dataBind();\n    removeClass([elem], ['e-check', 'e-stop', 'e-uncheck']);\n    addClass([elem], className);\n  };\n\n  CheckBoxFilterBase.prototype.createFilterItems = function (data, isInitial) {\n    var _a;\n\n    var cBoxes = this.parent.createElement('div');\n    var btn = this.dialogObj.btnObj[0];\n    var nullCounter = -1;\n\n    for (var i = 0; i < data.length; i++) {\n      var val = getValue('ejValue', data[i]);\n\n      if (val === '' || isNullOrUndefined(val)) {\n        nullCounter = nullCounter + 1;\n      }\n    }\n\n    this.itemsCnt = nullCounter !== -1 ? data.length - nullCounter : data.length;\n\n    if (data.length && !this.renderEmpty) {\n      var selectAllValue = this.getLocalizedLabel('SelectAll');\n      var checkBox = this.createCheckbox(selectAllValue, false, (_a = {}, _a[this.options.field] = selectAllValue, _a));\n      var selectAll = createCboxWithWrap(getUid('cbox'), checkBox, 'e-ftrchk');\n      selectAll.querySelector('.e-frame').classList.add('e-selectall');\n      cBoxes.appendChild(selectAll);\n      var predicate = new Predicate('field', 'equal', this.options.field);\n\n      if (this.options.foreignKeyValue) {\n        predicate = predicate.or('field', 'equal', this.options.foreignKeyValue);\n      }\n\n      var isColFiltered = new DataManager(this.options.filteredColumns).executeLocal(new Query().where(predicate)).length;\n      var isRndere = void 0;\n\n      for (var i = 0; i < data.length; i++) {\n        var uid = getUid('cbox');\n        this.values[uid] = getValue('ejValue', data[i]);\n        var value = getValue(this.options.field, data[i]);\n\n        if (this.options.formatFn) {\n          value = this.valueFormatter.toView(value, this.options.formatFn);\n        }\n\n        var args_1 = {\n          value: value,\n          column: this.options.column,\n          data: data[i]\n        };\n        this.parent.notify(events.filterCboxValue, args_1);\n        value = args_1.value;\n\n        if (value === '' || isNullOrUndefined(value)) {\n          if (isRndere) {\n            continue;\n          }\n\n          isRndere = true;\n        }\n\n        var checkbox = this.createCheckbox(value, this.getCheckedState(isColFiltered, this.values[uid]), getValue('dataObj', data[i]));\n        cBoxes.appendChild(createCboxWithWrap(uid, checkbox, 'e-ftrchk'));\n      }\n\n      this.cBox.innerHTML = '';\n      appendChildren(this.cBox, [].slice.call(cBoxes.children));\n      this.updateIndeterminatenBtn();\n      btn.disabled = false;\n    } else {\n      cBoxes.appendChild(this.parent.createElement('span', {\n        innerHTML: this.getLocalizedLabel('NoResult')\n      }));\n      this.cBox.innerHTML = '';\n      appendChildren(this.cBox, [].slice.call(cBoxes.children));\n      btn.disabled = true;\n    }\n\n    this.filterState = !btn.disabled;\n    btn.dataBind();\n    var args = {\n      requestType: events.filterChoiceRequest,\n      dataSource: this.renderEmpty || isBlazor() && this.parent.isServerRendered ? [] : data\n    };\n\n    if (!isBlazor() || this.parent.isJsComponent) {\n      var filterModel = 'filterModel';\n      args[filterModel] = this;\n    }\n\n    this.parent.notify(events.cBoxFltrComplete, args);\n    hideSpinner(this.spinner);\n  };\n\n  CheckBoxFilterBase.prototype.getCheckedState = function (isColFiltered, value) {\n    if (!this.isFiltered || !isColFiltered) {\n      return true;\n    } else {\n      return this.result[value];\n    }\n  };\n\n  CheckBoxFilterBase.getDistinct = function (json, field, column, foreignKeyData) {\n    var len = json.length;\n    var result = [];\n    var value;\n    var ejValue = 'ejValue';\n    var lookup = {};\n    var isForeignKey = column && column.isForeignColumn ? column.isForeignColumn() : false;\n\n    while (len--) {\n      value = json[len];\n      value = getObject(field, value); //local remote diff, check with mdu   \n\n      if (!(value in lookup)) {\n        var obj = {};\n        obj[ejValue] = value;\n        lookup[value] = true;\n\n        if (isForeignKey) {\n          var foreignDataObj = getForeignData(column, {}, value, foreignKeyData)[0];\n          setValue(events.foreignKeyData, foreignDataObj, json[len]);\n          value = getValue(column.foreignKeyValue, foreignDataObj);\n        }\n\n        setValue(field, isNullOrUndefined(value) ? null : value, obj);\n        setValue('dataObj', json[len], obj);\n        result.push(obj);\n      }\n    }\n\n    return DataUtil.group(DataUtil.sort(result, field, DataUtil.fnAscending), 'ejValue');\n  };\n\n  CheckBoxFilterBase.getPredicate = function (columns) {\n    var cols = DataUtil.distinct(columns, 'field', true) || [];\n    var collection = [];\n    var pred = {};\n\n    for (var i = 0; i < cols.length; i++) {\n      collection = new DataManager(columns).executeLocal(new Query().where('field', 'equal', cols[i].field));\n\n      if (collection.length !== 0) {\n        pred[cols[i].field] = CheckBoxFilterBase.generatePredicate(collection);\n      }\n    }\n\n    return pred;\n  };\n\n  CheckBoxFilterBase.generatePredicate = function (cols) {\n    var len = cols ? cols.length : 0;\n    var predicate;\n    var first;\n    var operate = 'or';\n    first = CheckBoxFilterBase.updateDateFilter(cols[0]);\n    first.ignoreAccent = !isNullOrUndefined(first.ignoreAccent) ? first.ignoreAccent : false;\n\n    if (first.type === 'date' || first.type === 'datetime') {\n      predicate = getDatePredicate(first, first.type);\n    } else {\n      predicate = first.ejpredicate ? first.ejpredicate : new Predicate(first.field, first.operator, first.value, !CheckBoxFilterBase.getCaseValue(first), first.ignoreAccent);\n    }\n\n    for (var p = 1; p < len; p++) {\n      cols[p] = CheckBoxFilterBase.updateDateFilter(cols[p]);\n\n      if (len > 2 && p > 1 && cols[p].predicate === 'or') {\n        if (cols[p].type === 'date' || cols[p].type === 'datetime') {\n          predicate.predicates.push(getDatePredicate(cols[p], cols[p].type));\n        } else {\n          predicate.predicates.push(new Predicate(cols[p].field, cols[p].operator, cols[p].value, !CheckBoxFilterBase.getCaseValue(cols[p]), cols[p].ignoreAccent));\n        }\n      } else {\n        if (cols[p].type === 'date' || cols[p].type === 'datetime') {\n          if (cols[p].predicate === 'and' && cols[p].operator === 'equal') {\n            predicate = predicate[operate](getDatePredicate(cols[p], cols[p].type), cols[p].type, cols[p].ignoreAccent);\n          } else {\n            predicate = predicate[cols[p].predicate](getDatePredicate(cols[p], cols[p].type), cols[p].type, cols[p].ignoreAccent);\n          }\n        } else {\n          /* tslint:disable-next-line:max-line-length */\n          predicate = cols[p].ejpredicate ? predicate[cols[p].predicate](cols[p].ejpredicate) : predicate[cols[p].predicate](cols[p].field, cols[p].operator, cols[p].value, !CheckBoxFilterBase.getCaseValue(cols[p]), cols[p].ignoreAccent);\n        }\n      }\n    }\n\n    return predicate || null;\n  };\n\n  CheckBoxFilterBase.getCaseValue = function (filter) {\n    if (isNullOrUndefined(filter.matchCase)) {\n      if (filter.type === 'string' || isNullOrUndefined(filter.type) && typeof filter.value === 'string') {\n        return false;\n      } else {\n        return true;\n      }\n    } else {\n      return filter.matchCase;\n    }\n  };\n\n  CheckBoxFilterBase.updateDateFilter = function (filter) {\n    if (filter.type === 'date' || filter.type === 'datetime' || filter.value instanceof Date) {\n      filter.type = filter.type || 'date';\n    }\n\n    return filter;\n  };\n\n  return CheckBoxFilterBase;\n}();\n\nexport { CheckBoxFilterBase };","map":null,"metadata":{},"sourceType":"module"}