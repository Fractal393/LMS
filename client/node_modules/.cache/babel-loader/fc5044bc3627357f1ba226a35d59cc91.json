{"ast":null,"code":"/**\r\n * DevExtreme (ui/grid_core/ui.grid_core.state_storing_core.js)\r\n * Version: 20.1.6\r\n * Build date: Fri Jul 17 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _events_engine = require(\"../../events/core/events_engine\");\n\nvar _events_engine2 = _interopRequireDefault(_events_engine);\n\nvar _window = require(\"../../core/utils/window\");\n\nvar _uiGrid_core = require(\"./ui.grid_core.modules\");\n\nvar _uiGrid_core2 = _interopRequireDefault(_uiGrid_core);\n\nvar _ui = require(\"../widget/ui.errors\");\n\nvar _ui2 = _interopRequireDefault(_ui);\n\nvar _browser = require(\"../../core/utils/browser\");\n\nvar _browser2 = _interopRequireDefault(_browser);\n\nvar _storage = require(\"../../core/utils/storage\");\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _iterator = require(\"../../core/utils/iterator\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar DATE_REGEX = /^(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2}(?:\\.\\d*)?)Z$/;\n\nvar parseDates = function parseDates(state) {\n  if (!state) {\n    return;\n  }\n\n  (0, _iterator.each)(state, function (key, value) {\n    if ((0, _type.isPlainObject)(value) || Array.isArray(value)) {\n      parseDates(value);\n    } else {\n      if (\"string\" === typeof value) {\n        var date = DATE_REGEX.exec(value);\n\n        if (date) {\n          state[key] = new Date(Date.UTC(+date[1], +date[2] - 1, +date[3], +date[4], +date[5], +date[6]));\n        }\n      }\n    }\n  });\n};\n\nexports.StateStoringController = _uiGrid_core2.default.ViewController.inherit(function () {\n  var getStorage = function (options) {\n    var storage = \"sessionStorage\" === options.type ? (0, _storage.sessionStorage)() : (0, _window.getWindow)().localStorage;\n\n    if (!storage) {\n      if (\"file:\" === (0, _window.getWindow)().location.protocol && _browser2.default.msie) {\n        throw new Error(\"E1038\");\n      } else {\n        throw new Error(\"E1007\");\n      }\n    }\n\n    return storage;\n  };\n\n  var getUniqueStorageKey = function (options) {\n    return (0, _type.isDefined)(options.storageKey) ? options.storageKey : \"storage\";\n  };\n\n  return {\n    _loadState: function () {\n      var options = this.option(\"stateStoring\");\n\n      if (\"custom\" === options.type) {\n        return options.customLoad && options.customLoad();\n      }\n\n      try {\n        return JSON.parse(getStorage(options).getItem(getUniqueStorageKey(options)));\n      } catch (e) {\n        _ui2.default.log(e.message);\n      }\n    },\n    _saveState: function (state) {\n      var options = this.option(\"stateStoring\");\n\n      if (\"custom\" === options.type) {\n        options.customSave && options.customSave(state);\n        return;\n      }\n\n      try {\n        getStorage(options).setItem(getUniqueStorageKey(options), JSON.stringify(state));\n      } catch (e) {\n        _ui2.default.log(e.message);\n      }\n    },\n    publicMethods: function () {\n      return [\"state\"];\n    },\n    isEnabled: function () {\n      return this.option(\"stateStoring.enabled\");\n    },\n    init: function () {\n      var that = this;\n      that._state = {};\n      that._isLoaded = false;\n      that._isLoading = false;\n\n      that._windowUnloadHandler = function () {\n        if (void 0 !== that._savingTimeoutID) {\n          that._saveState(that.state());\n        }\n      };\n\n      _events_engine2.default.on((0, _window.getWindow)(), \"unload\", that._windowUnloadHandler);\n\n      return that;\n    },\n    isLoaded: function () {\n      return this._isLoaded;\n    },\n    isLoading: function () {\n      return this._isLoading;\n    },\n    load: function () {\n      var _this = this;\n\n      this._isLoading = true;\n      var loadResult = (0, _deferred.fromPromise)(this._loadState());\n      loadResult.always(function () {\n        _this._isLoaded = true;\n        _this._isLoading = false;\n      }).done(function (state) {\n        _this.state(state);\n      });\n      return loadResult;\n    },\n    state: function (_state) {\n      var that = this;\n\n      if (!arguments.length) {\n        return (0, _extend.extend)(true, {}, that._state);\n      } else {\n        that._state = (0, _extend.extend)({}, _state);\n        parseDates(that._state);\n      }\n    },\n    save: function () {\n      var that = this;\n      clearTimeout(that._savingTimeoutID);\n      that._savingTimeoutID = setTimeout(function () {\n        that._saveState(that.state());\n\n        that._savingTimeoutID = void 0;\n      }, that.option(\"stateStoring.savingTimeout\"));\n    },\n    optionChanged: function (args) {\n      var that = this;\n\n      switch (args.name) {\n        case \"stateStoring\":\n          if (that.isEnabled() && !that.isLoading()) {\n            that.load();\n          }\n\n          args.handled = true;\n          break;\n\n        default:\n          that.callBase(args);\n      }\n    },\n    dispose: function () {\n      clearTimeout(this._savingTimeoutID);\n\n      _events_engine2.default.off((0, _window.getWindow)(), \"unload\", this._windowUnloadHandler);\n    }\n  };\n}());","map":null,"metadata":{},"sourceType":"script"}