{"ast":null,"code":"/**\r\n * DevExtreme (ui/hierarchical_collection/ui.data_converter.js)\r\n * Version: 20.1.6\r\n * Build date: Fri Jul 17 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar Class = require(\"../../core/class\");\n\nvar extend = require(\"../../core/utils/extend\").extend;\n\nvar errors = require(\"../../ui/widget/ui.errors\");\n\nvar each = require(\"../../core/utils/iterator\").each;\n\nvar typeUtils = require(\"../../core/utils/type\");\n\nvar DataConverter = Class.inherit({\n  ctor: function () {\n    this._dataStructure = [];\n    this._itemsCount = 0;\n    this._visibleItemsCount = 0;\n  },\n  _indexByKey: {},\n  _convertItemsToNodes: function (items, parentKey) {\n    var that = this;\n    each(items, function (_, item) {\n      var parentId = typeUtils.isDefined(parentKey) ? parentKey : that._getParentId(item);\n\n      var node = that._convertItemToNode(item, parentId);\n\n      that._dataStructure.push(node);\n\n      that._checkForDuplicateId(node.internalFields.key);\n\n      that._indexByKey[node.internalFields.key] = that._dataStructure.length - 1;\n\n      if (that._itemHasChildren(item)) {\n        that._convertItemsToNodes(that._dataAccessors.getters.items(item), node.internalFields.key);\n      }\n    });\n  },\n  _checkForDuplicateId: function (key) {\n    if (typeUtils.isDefined(this._indexByKey[key])) {\n      throw errors.Error(\"E1040\", key);\n    }\n  },\n  _getParentId: function (item) {\n    return \"plain\" === this._dataType ? this._dataAccessors.getters.parentKey(item) : void 0;\n  },\n  _itemHasChildren: function (item) {\n    if (\"plain\" === this._dataType) {\n      return;\n    }\n\n    var items = this._dataAccessors.getters.items(item);\n\n    return items && items.length;\n  },\n  _getUniqueKey: function (item) {\n    var keyGetter = this._dataAccessors.getters.key;\n    var itemKey = keyGetter(item);\n    var isCorrectKey = keyGetter && (itemKey || 0 === itemKey) && typeUtils.isPrimitive(itemKey);\n    return isCorrectKey ? itemKey : this.getItemsCount();\n  },\n  _convertItemToNode: function (item, parentKey) {\n    this._itemsCount++;\n    false !== item.visible && this._visibleItemsCount++;\n    var that = this;\n    var node = {\n      internalFields: {\n        disabled: that._dataAccessors.getters.disabled(item, {\n          defaultValue: false\n        }),\n        expanded: that._dataAccessors.getters.expanded(item, {\n          defaultValue: false\n        }),\n        selected: that._dataAccessors.getters.selected(item, {\n          defaultValue: false\n        }),\n        key: that._getUniqueKey(item),\n        parentKey: typeUtils.isDefined(parentKey) ? parentKey : that._rootValue,\n        item: that._makeObjectFromPrimitive(item),\n        childrenKeys: []\n      }\n    };\n    extend(node, item);\n    delete node.items;\n    return node;\n  },\n  setChildrenKeys: function () {\n    var that = this;\n    each(this._dataStructure, function (_, node) {\n      if (node.internalFields.parentKey === that._rootValue) {\n        return;\n      }\n\n      var parent = that.getParentNode(node);\n      parent && parent.internalFields.childrenKeys.push(node.internalFields.key);\n    });\n  },\n  _makeObjectFromPrimitive: function (item) {\n    if (typeUtils.isPrimitive(item)) {\n      var key = item;\n      item = {};\n\n      this._dataAccessors.setters.key(item, key);\n    }\n\n    return item;\n  },\n  _convertToPublicNode: function (node, parent) {\n    if (!node) {\n      return null;\n    }\n\n    var publicNode = {\n      text: this._dataAccessors.getters.display(node),\n      key: node.internalFields.key,\n      selected: node.internalFields.selected,\n      expanded: node.internalFields.expanded,\n      disabled: node.internalFields.disabled,\n      parent: parent || null,\n      itemData: node.internalFields.item,\n      children: [],\n      items: []\n    };\n\n    if (publicNode.parent) {\n      publicNode.parent.children.push(publicNode);\n      publicNode.parent.items.push(publicNode);\n    }\n\n    return publicNode;\n  },\n  convertToPublicNodes: function (data, parent) {\n    if (!data.length) {\n      return [];\n    }\n\n    var that = this;\n    var publicNodes = [];\n    each(data, function (_, node) {\n      node = typeUtils.isPrimitive(node) ? that._getByKey(node) : node;\n\n      var publicNode = that._convertToPublicNode(node, parent);\n\n      publicNode.children = that.convertToPublicNodes(node.internalFields.childrenKeys, publicNode);\n      publicNodes.push(publicNode);\n      node.internalFields.publicNode = publicNode;\n    });\n    return publicNodes;\n  },\n  setDataAccessors: function (accessors) {\n    this._dataAccessors = accessors;\n  },\n  _getByKey: function (key) {\n    return this._dataStructure[this.getIndexByKey(key)] || null;\n  },\n  getParentNode: function (node) {\n    return this._getByKey(node.internalFields.parentKey);\n  },\n  getByKey: function getByKey(data, key) {\n    var result = null;\n    var that = this;\n\n    var getByKey = function (data, key) {\n      each(data, function (_, element) {\n        var currentElementKey = element.internalFields && element.internalFields.key || that._dataAccessors.getters.key(element);\n\n        if (currentElementKey.toString() === key.toString()) {\n          result = element;\n          return false;\n        }\n      });\n      return result;\n    };\n\n    return getByKey(data, key);\n  },\n  getItemsCount: function () {\n    return this._itemsCount;\n  },\n  getVisibleItemsCount: function () {\n    return this._visibleItemsCount;\n  },\n  updateIndexByKey: function () {\n    var that = this;\n    this._indexByKey = {};\n    each(this._dataStructure, function (index, node) {\n      that._checkForDuplicateId(node.internalFields.key);\n\n      that._indexByKey[node.internalFields.key] = index;\n    });\n  },\n  updateChildrenKeys: function () {\n    this._indexByKey = {};\n    this.removeChildrenKeys();\n    this.updateIndexByKey();\n    this.setChildrenKeys();\n  },\n  removeChildrenKeys: function () {\n    this._indexByKey = {};\n    each(this._dataStructure, function (index, node) {\n      node.internalFields.childrenKeys = [];\n    });\n  },\n  getIndexByKey: function (key) {\n    return this._indexByKey[key];\n  },\n  createPlainStructure: function (items, rootValue, dataType) {\n    this._itemsCount = 0;\n    this._visibleItemsCount = 0;\n    this._rootValue = rootValue;\n    this._dataType = dataType;\n    this._indexByKey = {};\n\n    this._convertItemsToNodes(items);\n\n    this.setChildrenKeys();\n    return this._dataStructure;\n  }\n});\nmodule.exports = DataConverter;","map":null,"metadata":{},"sourceType":"script"}