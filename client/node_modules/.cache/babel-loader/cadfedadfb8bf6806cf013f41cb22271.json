{"ast":null,"code":"/**\r\n * DevExtreme (ui/grid_core/ui.grid_core.search.js)\r\n * Version: 20.1.6\r\n * Build date: Fri Jul 17 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _dom_adapter = require(\"../../core/dom_adapter\");\n\nvar _dom_adapter2 = _interopRequireDefault(_dom_adapter);\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _data = require(\"../../core/utils/data\");\n\nvar _iterator = require(\"../../core/utils/iterator\");\n\nvar _uiGrid_core = require(\"./ui.grid_core.utils\");\n\nvar _message = require(\"../../localization/message\");\n\nvar _message2 = _interopRequireDefault(_message);\n\nvar _query = require(\"../../data/query\");\n\nvar _query2 = _interopRequireDefault(_query);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar SEARCH_PANEL_CLASS = \"search-panel\";\nvar SEARCH_TEXT_CLASS = \"search-text\";\nvar HEADER_PANEL_CLASS = \"header-panel\";\nvar FILTERING_TIMEOUT = 700;\n\nfunction allowSearch(column) {\n  return (0, _type.isDefined)(column.allowSearch) ? column.allowSearch : column.allowFiltering;\n}\n\nfunction parseValue(column, text) {\n  var lookup = column.lookup;\n\n  if (!column.parseValue) {\n    return text;\n  }\n\n  if (lookup) {\n    return column.parseValue.call(lookup, text);\n  }\n\n  return column.parseValue(text);\n}\n\nmodule.exports = {\n  defaultOptions: function () {\n    return {\n      searchPanel: {\n        visible: false,\n        width: 160,\n        placeholder: _message2.default.format(\"dxDataGrid-searchPanelPlaceholder\"),\n        highlightSearchText: true,\n        highlightCaseSensitive: false,\n        text: \"\",\n        searchVisibleColumnsOnly: false\n      }\n    };\n  },\n  extenders: {\n    controllers: {\n      data: function () {\n        var calculateSearchFilter = function (that, text) {\n          var i;\n          var column;\n\n          var columns = that._columnsController.getColumns();\n\n          var searchVisibleColumnsOnly = that.option(\"searchPanel.searchVisibleColumnsOnly\");\n          var lookup;\n          var filters = [];\n\n          if (!text) {\n            return null;\n          }\n\n          function onQueryDone(items) {\n            var valueGetter = (0, _data.compileGetter)(lookup.valueExpr);\n\n            for (var _i = 0; _i < items.length; _i++) {\n              var value = valueGetter(items[_i]);\n              filters.push(column.createFilterExpression(value, null, \"search\"));\n            }\n          }\n\n          for (i = 0; i < columns.length; i++) {\n            column = columns[i];\n\n            if (searchVisibleColumnsOnly && !column.visible) {\n              continue;\n            }\n\n            if (allowSearch(column) && column.calculateFilterExpression) {\n              lookup = column.lookup;\n              var filterValue = parseValue(column, text);\n\n              if (lookup && lookup.items) {\n                (0, _query2.default)(lookup.items).filter(column.createFilterExpression.call({\n                  dataField: lookup.displayExpr,\n                  dataType: lookup.dataType,\n                  calculateFilterExpression: column.calculateFilterExpression\n                }, filterValue, null, \"search\")).enumerate().done(onQueryDone);\n              } else {\n                if (void 0 !== filterValue) {\n                  filters.push(column.createFilterExpression(filterValue, null, \"search\"));\n                }\n              }\n            }\n          }\n\n          return (0, _uiGrid_core.combineFilters)(filters, \"or\");\n        };\n\n        return {\n          publicMethods: function () {\n            return this.callBase().concat([\"searchByText\"]);\n          },\n          _calculateAdditionalFilter: function () {\n            var that = this;\n            var filter = that.callBase();\n            var searchFilter = calculateSearchFilter(that, that.option(\"searchPanel.text\"));\n            return (0, _uiGrid_core.combineFilters)([filter, searchFilter]);\n          },\n          searchByText: function (text) {\n            this.option(\"searchPanel.text\", text);\n          },\n          optionChanged: function (args) {\n            var that = this;\n\n            switch (args.fullName) {\n              case \"searchPanel.text\":\n              case \"searchPanel\":\n                that._applyFilter();\n\n                args.handled = true;\n                break;\n\n              default:\n                that.callBase(args);\n            }\n          }\n        };\n      }()\n    },\n    views: {\n      headerPanel: function () {\n        var getSearchPanelOptions = function (that) {\n          return that.option(\"searchPanel\");\n        };\n\n        return {\n          _getToolbarItems: function () {\n            var items = this.callBase();\n            return this._prepareSearchItem(items);\n          },\n          _prepareSearchItem: function (items) {\n            var that = this;\n            var dataController = that.getController(\"data\");\n            var searchPanelOptions = getSearchPanelOptions(that);\n\n            if (searchPanelOptions && searchPanelOptions.visible) {\n              var toolbarItem = {\n                template: function (data, index, container) {\n                  var $search = (0, _renderer2.default)(\"<div>\").addClass(that.addWidgetPrefix(SEARCH_PANEL_CLASS)).appendTo(container);\n                  that.getController(\"editorFactory\").createEditor($search, {\n                    width: searchPanelOptions.width,\n                    placeholder: searchPanelOptions.placeholder,\n                    parentType: \"searchPanel\",\n                    value: that.option(\"searchPanel.text\"),\n                    updateValueTimeout: FILTERING_TIMEOUT,\n                    setValue: function (value) {\n                      dataController.searchByText(value);\n                    },\n                    editorOptions: {\n                      inputAttr: {\n                        \"aria-label\": _message2.default.format(\"dxDataGrid-ariaSearchInGrid\")\n                      }\n                    }\n                  });\n                  that.resize();\n                },\n                name: \"searchPanel\",\n                location: \"after\",\n                locateInMenu: \"never\",\n                sortIndex: 40\n              };\n              items.push(toolbarItem);\n            }\n\n            return items;\n          },\n          getSearchTextEditor: function () {\n            var that = this;\n            var $element = that.element();\n            var $searchPanel = $element.find(\".\" + that.addWidgetPrefix(SEARCH_PANEL_CLASS)).filter(function () {\n              return (0, _renderer2.default)(this).closest(\".\" + that.addWidgetPrefix(HEADER_PANEL_CLASS)).is($element);\n            });\n\n            if ($searchPanel.length) {\n              return $searchPanel.dxTextBox(\"instance\");\n            }\n\n            return null;\n          },\n          isVisible: function () {\n            var searchPanelOptions = getSearchPanelOptions(this);\n            return this.callBase() || searchPanelOptions && searchPanelOptions.visible;\n          },\n          optionChanged: function (args) {\n            if (\"searchPanel\" === args.name) {\n              if (\"searchPanel.text\" === args.fullName) {\n                var editor = this.getSearchTextEditor();\n\n                if (editor) {\n                  editor.option(\"value\", args.value);\n                }\n              } else {\n                this._invalidate();\n              }\n\n              args.handled = true;\n            } else {\n              this.callBase(args);\n            }\n          }\n        };\n      }(),\n      rowsView: {\n        init: function () {\n          this.callBase.apply(this, arguments);\n          this._searchParams = [];\n        },\n        _getFormattedSearchText: function (column, searchText) {\n          var value = parseValue(column, searchText);\n          var formatOptions = (0, _uiGrid_core.getFormatOptionsByColumn)(column, \"search\");\n          return (0, _uiGrid_core.formatValue)(value, formatOptions);\n        },\n        _getStringNormalizer: function () {\n          var isCaseSensitive = this.option(\"searchPanel.highlightCaseSensitive\");\n          return function (str) {\n            return isCaseSensitive ? str : str.toLowerCase();\n          };\n        },\n        _findHighlightingTextNodes: function (column, cellElement, searchText) {\n          var that = this;\n          var $parent = cellElement.parent();\n          var $items;\n\n          var stringNormalizer = this._getStringNormalizer();\n\n          var normalizedSearchText = stringNormalizer(searchText);\n\n          if (!$parent.length) {\n            $parent = (0, _renderer2.default)(\"<div>\").append(cellElement);\n          } else {\n            if (column) {\n              if (column.groupIndex >= 0 && !column.showWhenGrouped) {\n                $items = cellElement;\n              } else {\n                var columnIndex = that._columnsController.getVisibleIndex(column.index);\n\n                $items = $parent.children(\"td\").eq(columnIndex).find(\"*\");\n              }\n            }\n          }\n\n          $items = $items && $items.length ? $items : $parent.find(\"*\");\n          $items = $items.filter(function (_, element) {\n            var $contents = (0, _renderer2.default)(element).contents();\n\n            for (var i = 0; i < $contents.length; i++) {\n              var node = $contents.get(i);\n\n              if (3 === node.nodeType) {\n                return stringNormalizer(node.textContent || node.nodeValue).indexOf(normalizedSearchText) > -1;\n              }\n\n              return false;\n            }\n          });\n          return $items;\n        },\n        _highlightSearchTextCore: function ($textNode, searchText) {\n          var that = this;\n          var $searchTextSpan = (0, _renderer2.default)(\"<span>\").addClass(that.addWidgetPrefix(SEARCH_TEXT_CLASS));\n          var text = $textNode.text();\n          var firstContentElement = $textNode[0];\n\n          var stringNormalizer = this._getStringNormalizer();\n\n          var index = stringNormalizer(text).indexOf(stringNormalizer(searchText));\n\n          if (index >= 0) {\n            if (firstContentElement.textContent) {\n              firstContentElement.textContent = text.substr(0, index);\n            } else {\n              firstContentElement.nodeValue = text.substr(0, index);\n            }\n\n            $textNode.after($searchTextSpan.text(text.substr(index, searchText.length)));\n            $textNode = (0, _renderer2.default)(_dom_adapter2.default.createTextNode(text.substr(index + searchText.length))).insertAfter($searchTextSpan);\n            return that._highlightSearchTextCore($textNode, searchText);\n          }\n        },\n        _highlightSearchText: function (cellElement, isEquals, column) {\n          var that = this;\n\n          var stringNormalizer = this._getStringNormalizer();\n\n          var searchText = that.option(\"searchPanel.text\");\n\n          if (isEquals && column) {\n            searchText = searchText && that._getFormattedSearchText(column, searchText);\n          }\n\n          if (searchText && that.option(\"searchPanel.highlightSearchText\")) {\n            var textNodes = that._findHighlightingTextNodes(column, cellElement, searchText);\n\n            (0, _iterator.each)(textNodes, function (_, element) {\n              (0, _iterator.each)((0, _renderer2.default)(element).contents(), function (_, textNode) {\n                if (isEquals) {\n                  if (stringNormalizer((0, _renderer2.default)(textNode).text()) === stringNormalizer(searchText)) {\n                    (0, _renderer2.default)(this).replaceWith((0, _renderer2.default)(\"<span>\").addClass(that.addWidgetPrefix(SEARCH_TEXT_CLASS)).text((0, _renderer2.default)(textNode).text()));\n                  }\n                } else {\n                  that._highlightSearchTextCore((0, _renderer2.default)(textNode), searchText);\n                }\n              });\n            });\n          }\n        },\n        _renderCore: function () {\n          this.callBase.apply(this, arguments);\n\n          if (this.option(\"rowTemplate\")) {\n            if (this.option(\"templatesRenderAsynchronously\")) {\n              clearTimeout(this._highlightTimer);\n              this._highlightTimer = setTimeout(function () {\n                this._highlightSearchText(this._getTableElement());\n              }.bind(this));\n            } else {\n              this._highlightSearchText(this._getTableElement());\n            }\n          }\n        },\n        _updateCell: function ($cell, parameters) {\n          var column = parameters.column;\n          var dataType = column.lookup && column.lookup.dataType || column.dataType;\n          var isEquals = \"string\" !== dataType;\n\n          if (allowSearch(column)) {\n            if (this.option(\"templatesRenderAsynchronously\")) {\n              if (!this._searchParams.length) {\n                clearTimeout(this._highlightTimer);\n                this._highlightTimer = setTimeout(function () {\n                  this._searchParams.forEach(function (params) {\n                    this._highlightSearchText.apply(this, params);\n                  }.bind(this));\n\n                  this._searchParams = [];\n                }.bind(this));\n              }\n\n              this._searchParams.push([$cell, isEquals, column]);\n            } else {\n              this._highlightSearchText($cell, isEquals, column);\n            }\n          }\n\n          this.callBase($cell, parameters);\n        },\n        dispose: function () {\n          clearTimeout(this._highlightTimer);\n          this.callBase();\n        }\n      }\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"script"}