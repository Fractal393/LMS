{"ast":null,"code":"/**\r\n * DevExtreme (ui/filter_builder/filter_builder.js)\r\n * Version: 20.1.6\r\n * Build date: Fri Jul 17 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _dom_adapter = require(\"../../core/dom_adapter\");\n\nvar _dom_adapter2 = _interopRequireDefault(_dom_adapter);\n\nvar _class = require(\"../../core/class\");\n\nvar _class2 = _interopRequireDefault(_class);\n\nvar _events_engine = require(\"../../events/core/events_engine\");\n\nvar _events_engine2 = _interopRequireDefault(_events_engine);\n\nvar _ui = require(\"../widget/ui.widget\");\n\nvar _ui2 = _interopRequireDefault(_ui);\n\nvar _component_registrator = require(\"../../core/component_registrator\");\n\nvar _component_registrator2 = _interopRequireDefault(_component_registrator);\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _message = require(\"../../localization/message\");\n\nvar _message2 = _interopRequireDefault(_message);\n\nvar _utils = require(\"./utils\");\n\nvar _utils2 = _interopRequireDefault(_utils);\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nvar _deferred2 = _interopRequireDefault(_deferred);\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _tree_view = require(\"../tree_view\");\n\nvar _tree_view2 = _interopRequireDefault(_tree_view);\n\nvar _popup = require(\"../popup\");\n\nvar _popup2 = _interopRequireDefault(_popup);\n\nvar _utils3 = require(\"../overlay/utils\");\n\nvar _ui3 = require(\"../shared/ui.editor_factory_mixin\");\n\nvar _ui4 = _interopRequireDefault(_ui3);\n\nvar _utils4 = require(\"../../events/utils\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar FILTER_BUILDER_CLASS = \"dx-filterbuilder\";\nvar FILTER_BUILDER_GROUP_CLASS = FILTER_BUILDER_CLASS + \"-group\";\nvar FILTER_BUILDER_GROUP_ITEM_CLASS = FILTER_BUILDER_GROUP_CLASS + \"-item\";\nvar FILTER_BUILDER_GROUP_CONTENT_CLASS = FILTER_BUILDER_GROUP_CLASS + \"-content\";\nvar FILTER_BUILDER_GROUP_OPERATIONS_CLASS = FILTER_BUILDER_GROUP_CLASS + \"-operations\";\nvar FILTER_BUILDER_GROUP_OPERATION_CLASS = FILTER_BUILDER_GROUP_CLASS + \"-operation\";\nvar FILTER_BUILDER_ACTION_CLASS = FILTER_BUILDER_CLASS + \"-action\";\nvar FILTER_BUILDER_IMAGE_CLASS = FILTER_BUILDER_ACTION_CLASS + \"-icon\";\nvar FILTER_BUILDER_IMAGE_ADD_CLASS = \"dx-icon-plus\";\nvar FILTER_BUILDER_IMAGE_REMOVE_CLASS = \"dx-icon-remove\";\nvar FILTER_BUILDER_ITEM_TEXT_CLASS = FILTER_BUILDER_CLASS + \"-text\";\nvar FILTER_BUILDER_ITEM_TEXT_PART_CLASS = FILTER_BUILDER_ITEM_TEXT_CLASS + \"-part\";\nvar FILTER_BUILDER_ITEM_TEXT_SEPARATOR_CLASS = FILTER_BUILDER_ITEM_TEXT_CLASS + \"-separator\";\nvar FILTER_BUILDER_ITEM_TEXT_SEPARATOR_EMPTY_CLASS = FILTER_BUILDER_ITEM_TEXT_SEPARATOR_CLASS + \"-empty\";\nvar FILTER_BUILDER_ITEM_FIELD_CLASS = FILTER_BUILDER_CLASS + \"-item-field\";\nvar FILTER_BUILDER_ITEM_OPERATION_CLASS = FILTER_BUILDER_CLASS + \"-item-operation\";\nvar FILTER_BUILDER_ITEM_VALUE_CLASS = FILTER_BUILDER_CLASS + \"-item-value\";\nvar FILTER_BUILDER_ITEM_VALUE_TEXT_CLASS = FILTER_BUILDER_CLASS + \"-item-value-text\";\nvar FILTER_BUILDER_OVERLAY_CLASS = FILTER_BUILDER_CLASS + \"-overlay\";\nvar FILTER_BUILDER_FILTER_OPERATIONS_CLASS = FILTER_BUILDER_CLASS + \"-operations\";\nvar FILTER_BUILDER_FIELDS_CLASS = FILTER_BUILDER_CLASS + \"-fields\";\nvar FILTER_BUILDER_ADD_CONDITION_CLASS = FILTER_BUILDER_CLASS + \"-add-condition\";\nvar ACTIVE_CLASS = \"dx-state-active\";\nvar FILTER_BUILDER_MENU_CUSTOM_OPERATION_CLASS = FILTER_BUILDER_CLASS + \"-menu-custom-operation\";\nvar SOURCE = \"filterBuilder\";\nvar DISABLED_STATE_CLASS = \"dx-state-disabled\";\nvar TAB_KEY = \"tab\";\nvar ENTER_KEY = \"enter\";\nvar ESCAPE_KEY = \"escape\";\nvar ACTIONS = [{\n  name: \"onEditorPreparing\",\n  config: {\n    excludeValidators: [\"disabled\", \"readOnly\"],\n    category: \"rendering\"\n  }\n}, {\n  name: \"onEditorPrepared\",\n  config: {\n    excludeValidators: [\"disabled\", \"readOnly\"],\n    category: \"rendering\"\n  }\n}, {\n  name: \"onValueChanged\",\n  config: {\n    excludeValidators: [\"disabled\", \"readOnly\"]\n  }\n}];\nvar OPERATORS = {\n  and: \"and\",\n  or: \"or\",\n  notAnd: \"!and\",\n  notOr: \"!or\"\n};\n\nvar EditorFactory = _class2.default.inherit(_ui4.default);\n\nvar renderValueText = function ($container, value, customOperation) {\n  if (Array.isArray(value)) {\n    var lastItemIndex = value.length - 1;\n    $container.empty();\n    value.forEach(function (t, i) {\n      (0, _renderer2.default)(\"<span>\").addClass(FILTER_BUILDER_ITEM_TEXT_PART_CLASS).text(t).appendTo($container);\n\n      if (i !== lastItemIndex) {\n        (0, _renderer2.default)(\"<span>\").addClass(FILTER_BUILDER_ITEM_TEXT_SEPARATOR_CLASS).text(customOperation && customOperation.valueSeparator ? customOperation.valueSeparator : \"|\").addClass(FILTER_BUILDER_ITEM_TEXT_SEPARATOR_EMPTY_CLASS).appendTo($container);\n      }\n    });\n  } else {\n    if (value) {\n      $container.text(value);\n    } else {\n      $container.text(_message2.default.format(\"dxFilterBuilder-enterValueText\"));\n    }\n  }\n};\n\nvar FilterBuilder = _ui2.default.inherit({\n  _getDefaultOptions: function () {\n    return (0, _extend.extend)(this.callBase(), {\n      onEditorPreparing: null,\n      onEditorPrepared: null,\n      onValueChanged: null,\n      fields: [],\n      defaultGroupOperation: \"and\",\n      groupOperations: [\"and\", \"or\", \"notAnd\", \"notOr\"],\n      maxGroupLevel: void 0,\n      value: null,\n      allowHierarchicalFields: false,\n      groupOperationDescriptions: {\n        and: _message2.default.format(\"dxFilterBuilder-and\"),\n        or: _message2.default.format(\"dxFilterBuilder-or\"),\n        notAnd: _message2.default.format(\"dxFilterBuilder-notAnd\"),\n        notOr: _message2.default.format(\"dxFilterBuilder-notOr\")\n      },\n      customOperations: [],\n      closePopupOnTargetScroll: true,\n      filterOperationDescriptions: {\n        between: _message2.default.format(\"dxFilterBuilder-filterOperationBetween\"),\n        equal: _message2.default.format(\"dxFilterBuilder-filterOperationEquals\"),\n        notEqual: _message2.default.format(\"dxFilterBuilder-filterOperationNotEquals\"),\n        lessThan: _message2.default.format(\"dxFilterBuilder-filterOperationLess\"),\n        lessThanOrEqual: _message2.default.format(\"dxFilterBuilder-filterOperationLessOrEquals\"),\n        greaterThan: _message2.default.format(\"dxFilterBuilder-filterOperationGreater\"),\n        greaterThanOrEqual: _message2.default.format(\"dxFilterBuilder-filterOperationGreaterOrEquals\"),\n        startsWith: _message2.default.format(\"dxFilterBuilder-filterOperationStartsWith\"),\n        contains: _message2.default.format(\"dxFilterBuilder-filterOperationContains\"),\n        notContains: _message2.default.format(\"dxFilterBuilder-filterOperationNotContains\"),\n        endsWith: _message2.default.format(\"dxFilterBuilder-filterOperationEndsWith\"),\n        isBlank: _message2.default.format(\"dxFilterBuilder-filterOperationIsBlank\"),\n        isNotBlank: _message2.default.format(\"dxFilterBuilder-filterOperationIsNotBlank\")\n      }\n    });\n  },\n  _optionChanged: function (args) {\n    switch (args.name) {\n      case \"closePopupOnTargetScroll\":\n        break;\n\n      case \"onEditorPreparing\":\n      case \"onEditorPrepared\":\n      case \"onValueChanged\":\n        this._initActions();\n\n        break;\n\n      case \"customOperations\":\n        this._initCustomOperations();\n\n        this._invalidate();\n\n        break;\n\n      case \"fields\":\n      case \"defaultGroupOperation\":\n      case \"maxGroupLevel\":\n      case \"groupOperations\":\n      case \"allowHierarchicalFields\":\n      case \"groupOperationDescriptions\":\n      case \"filterOperationDescriptions\":\n        this._invalidate();\n\n        break;\n\n      case \"value\":\n        if (args.value !== args.previousValue) {\n          var disableInvalidateForValue = this._disableInvalidateForValue;\n\n          if (!disableInvalidateForValue) {\n            this._initModel();\n\n            this._invalidate();\n          }\n\n          this._disableInvalidateForValue = false;\n          this.executeAction(\"onValueChanged\", {\n            value: args.value,\n            previousValue: args.previousValue\n          });\n          this._disableInvalidateForValue = disableInvalidateForValue;\n        }\n\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  },\n  getFilterExpression: function () {\n    var fields = this._getNormalizedFields();\n\n    var value = (0, _extend.extend)(true, [], this._model);\n    return _utils2.default.getFilterExpression(_utils2.default.getNormalizedFilter(value), fields, this._customOperations, SOURCE);\n  },\n  _getNormalizedFields: function () {\n    return _utils2.default.getNormalizedFields(this.option(\"fields\"));\n  },\n  _updateFilter: function () {\n    this._disableInvalidateForValue = true;\n    var value = (0, _extend.extend)(true, [], this._model);\n\n    var normalizedValue = _utils2.default.getNormalizedFilter(value);\n\n    var oldValue = _utils2.default.getNormalizedFilter(this._getModel(this.option(\"value\")));\n\n    if (JSON.stringify(oldValue) !== JSON.stringify(normalizedValue)) {\n      this.option(\"value\", normalizedValue);\n    }\n\n    this._disableInvalidateForValue = false;\n\n    this._fireContentReadyAction();\n  },\n  _init: function () {\n    this._initCustomOperations();\n\n    this._initModel();\n\n    this._initEditorFactory();\n\n    this._initActions();\n\n    this.callBase();\n  },\n  _initEditorFactory: function () {\n    this._editorFactory = new EditorFactory();\n  },\n  _initCustomOperations: function () {\n    this._customOperations = _utils2.default.getMergedOperations(this.option(\"customOperations\"), this.option(\"filterOperationDescriptions.between\"), this);\n  },\n  _getModel: function (value) {\n    return _utils2.default.convertToInnerStructure(value, this._customOperations);\n  },\n  _initModel: function () {\n    this._model = this._getModel(this.option(\"value\"));\n  },\n  _initActions: function () {\n    var that = this;\n    that._actions = {};\n    ACTIONS.forEach(function (action) {\n      that._actions[action.name] = that._createActionByOption(action.name, action.config);\n    });\n  },\n  executeAction: function (actionName, options) {\n    var action = this._actions[actionName];\n    return action && action(options);\n  },\n  _initMarkup: function () {\n    this.$element().addClass(FILTER_BUILDER_CLASS);\n    this.callBase();\n\n    this._createGroupElementByCriteria(this._model).appendTo(this.$element());\n  },\n  _createConditionElement: function (condition, parent) {\n    return (0, _renderer2.default)(\"<div>\").addClass(FILTER_BUILDER_GROUP_CLASS).append(this._createConditionItem(condition, parent));\n  },\n  _createGroupElementByCriteria: function (criteria, parent) {\n    var groupLevel = arguments.length > 2 && void 0 !== arguments[2] ? arguments[2] : 0;\n\n    var $group = this._createGroupElement(criteria, parent, groupLevel);\n\n    var $groupContent = $group.find(\".\" + FILTER_BUILDER_GROUP_CONTENT_CLASS);\n\n    var groupCriteria = _utils2.default.getGroupCriteria(criteria);\n\n    for (var i = 0; i < groupCriteria.length; i++) {\n      var innerCriteria = groupCriteria[i];\n\n      if (_utils2.default.isGroup(innerCriteria)) {\n        this._createGroupElementByCriteria(innerCriteria, groupCriteria, groupLevel + 1).appendTo($groupContent);\n      } else {\n        if (_utils2.default.isCondition(innerCriteria)) {\n          this._createConditionElement(innerCriteria, groupCriteria).appendTo($groupContent);\n        }\n      }\n    }\n\n    return $group;\n  },\n  _createGroupElement: function (criteria, parent, groupLevel) {\n    var _this = this;\n\n    var $groupItem = (0, _renderer2.default)(\"<div>\").addClass(FILTER_BUILDER_GROUP_ITEM_CLASS);\n    var $groupContent = (0, _renderer2.default)(\"<div>\").addClass(FILTER_BUILDER_GROUP_CONTENT_CLASS);\n    var $group = (0, _renderer2.default)(\"<div>\").addClass(FILTER_BUILDER_GROUP_CLASS).append($groupItem).append($groupContent);\n\n    if (null != parent) {\n      this._createRemoveButton(function () {\n        _utils2.default.removeItem(parent, criteria);\n\n        $group.remove();\n\n        _this._updateFilter();\n      }).appendTo($groupItem);\n    }\n\n    this._createGroupOperationButton(criteria).appendTo($groupItem);\n\n    this._createAddButton(function () {\n      var newGroup = _utils2.default.createEmptyGroup(_this.option(\"defaultGroupOperation\"));\n\n      _utils2.default.addItem(newGroup, criteria);\n\n      _this._createGroupElement(newGroup, criteria, groupLevel + 1).appendTo($groupContent);\n\n      _this._updateFilter();\n    }, function () {\n      var field = _this.option(\"fields\")[0];\n\n      var newCondition = _utils2.default.createCondition(field, _this._customOperations);\n\n      _utils2.default.addItem(newCondition, criteria);\n\n      _this._createConditionElement(newCondition, criteria).appendTo($groupContent);\n\n      _this._updateFilter();\n    }, groupLevel).appendTo($groupItem);\n\n    return $group;\n  },\n  _createButton: function (caption) {\n    return (0, _renderer2.default)(\"<div>\").text(caption);\n  },\n  _createGroupOperationButton: function (criteria) {\n    var _this2 = this;\n\n    var groupOperations = this._getGroupOperations(criteria);\n\n    var groupMenuItem = _utils2.default.getGroupMenuItem(criteria, groupOperations);\n\n    var caption = groupMenuItem.text;\n    var $operationButton = groupOperations && groupOperations.length < 2 ? this._createButton(caption).addClass(DISABLED_STATE_CLASS) : this._createButtonWithMenu({\n      caption: caption,\n      menu: {\n        items: groupOperations,\n        displayExpr: \"text\",\n        keyExpr: \"value\",\n        onItemClick: function (e) {\n          if (groupMenuItem !== e.itemData) {\n            _utils2.default.setGroupValue(criteria, e.itemData.value);\n\n            $operationButton.html(e.itemData.text);\n            groupMenuItem = e.itemData;\n\n            _this2._updateFilter();\n          }\n        },\n        onContentReady: function (e) {\n          e.component.selectItem(groupMenuItem);\n        },\n        cssClass: FILTER_BUILDER_GROUP_OPERATIONS_CLASS\n      }\n    });\n    return $operationButton.addClass(FILTER_BUILDER_ITEM_TEXT_CLASS).addClass(FILTER_BUILDER_GROUP_OPERATION_CLASS).attr(\"tabindex\", 0);\n  },\n  _createButtonWithMenu: function (options) {\n    var that = this;\n\n    var removeMenu = function () {\n      that.$element().find(\".\" + ACTIVE_CLASS).removeClass(ACTIVE_CLASS);\n      that.$element().find(\".dx-overlay .dx-treeview\").remove();\n      that.$element().find(\".dx-overlay\").remove();\n    };\n\n    var rtlEnabled = this.option(\"rtlEnabled\");\n\n    var menuOnItemClickWrapper = function (handler) {\n      return function (e) {\n        handler(e);\n\n        if (\"dxclick\" === e.event.type) {\n          removeMenu();\n        }\n      };\n    };\n\n    var position = rtlEnabled ? \"right\" : \"left\";\n\n    var $button = this._createButton(options.caption);\n\n    (0, _extend.extend)(options.menu, {\n      focusStateEnabled: true,\n      selectionMode: \"single\",\n      onItemClick: menuOnItemClickWrapper(options.menu.onItemClick),\n      onHiding: function (e) {\n        $button.removeClass(ACTIVE_CLASS);\n      },\n      position: {\n        my: position + \" top\",\n        at: position + \" bottom\",\n        offset: \"0 1\",\n        of: $button,\n        collision: \"flip\"\n      },\n      animation: null,\n      onHidden: function () {\n        removeMenu();\n      },\n      cssClass: FILTER_BUILDER_OVERLAY_CLASS + \" \" + options.menu.cssClass,\n      rtlEnabled: rtlEnabled\n    });\n    options.popup = {\n      onShown: function (info) {\n        var treeViewElement = (0, _renderer2.default)(info.component.content()).find(\".dx-treeview\");\n        var treeView = treeViewElement.dxTreeView(\"instance\");\n\n        _events_engine2.default.on(treeViewElement, \"keyup keydown\", function (e) {\n          var keyName = (0, _utils4.normalizeKeyName)(e);\n\n          if (\"keydown\" === e.type && keyName === TAB_KEY || \"keyup\" === e.type && (keyName === ESCAPE_KEY || keyName === ENTER_KEY)) {\n            info.component.hide();\n\n            _events_engine2.default.trigger(options.menu.position.of, \"focus\");\n          }\n        });\n\n        treeView.focus();\n        treeView.option(\"focusedElement\", null);\n      }\n    };\n\n    this._subscribeOnClickAndEnterKey($button, function () {\n      removeMenu();\n\n      that._createPopupWithTreeView(options, that.$element());\n\n      $button.addClass(ACTIVE_CLASS);\n    });\n\n    return $button;\n  },\n  _hasValueButton: function (condition) {\n    var customOperation = _utils2.default.getCustomOperation(this._customOperations, condition[1]);\n\n    return customOperation ? false !== customOperation.hasValue : null !== condition[2];\n  },\n  _createOperationButtonWithMenu: function (condition, field) {\n    var _this3 = this;\n\n    var that = this;\n\n    var availableOperations = _utils2.default.getAvailableOperations(field, this.option(\"filterOperationDescriptions\"), this._customOperations);\n\n    var currentOperation = _utils2.default.getOperationFromAvailable(_utils2.default.getOperationValue(condition), availableOperations);\n\n    var $operationButton = this._createButtonWithMenu({\n      caption: currentOperation.text,\n      menu: {\n        items: availableOperations,\n        displayExpr: \"text\",\n        onItemRendered: function (e) {\n          e.itemData.isCustom && (0, _renderer2.default)(e.itemElement).addClass(FILTER_BUILDER_MENU_CUSTOM_OPERATION_CLASS);\n        },\n        onContentReady: function (e) {\n          e.component.selectItem(currentOperation);\n        },\n        onItemClick: function (e) {\n          if (currentOperation !== e.itemData) {\n            currentOperation = e.itemData;\n\n            _utils2.default.updateConditionByOperation(condition, currentOperation.value, that._customOperations);\n\n            var $valueButton = $operationButton.siblings().filter(\".\" + FILTER_BUILDER_ITEM_VALUE_CLASS);\n\n            if (that._hasValueButton(condition)) {\n              if (0 !== $valueButton.length) {\n                $valueButton.remove();\n              }\n\n              that._createValueButton(condition, field).appendTo($operationButton.parent());\n            } else {\n              $valueButton.remove();\n            }\n\n            $operationButton.html(currentOperation.text);\n\n            _this3._updateFilter();\n          }\n        },\n        cssClass: FILTER_BUILDER_FILTER_OPERATIONS_CLASS\n      }\n    }).addClass(FILTER_BUILDER_ITEM_TEXT_CLASS).addClass(FILTER_BUILDER_ITEM_OPERATION_CLASS).attr(\"tabindex\", 0);\n\n    return $operationButton;\n  },\n  _createOperationAndValueButtons: function (condition, field, $item) {\n    this._createOperationButtonWithMenu(condition, field).appendTo($item);\n\n    if (this._hasValueButton(condition)) {\n      this._createValueButton(condition, field).appendTo($item);\n    }\n  },\n  _createFieldButtonWithMenu: function (fields, condition, field) {\n    var _this4 = this;\n\n    var that = this;\n    var allowHierarchicalFields = this.option(\"allowHierarchicalFields\");\n\n    var items = _utils2.default.getItems(fields, allowHierarchicalFields);\n\n    var item = _utils2.default.getField(field.name || field.dataField, items);\n\n    var getFullCaption = function (item, items) {\n      return allowHierarchicalFields ? _utils2.default.getCaptionWithParents(item, items) : item.caption;\n    };\n\n    var $fieldButton = this._createButtonWithMenu({\n      caption: getFullCaption(item, items),\n      menu: {\n        items: items,\n        dataStructure: \"plain\",\n        keyExpr: \"id\",\n        parentId: \"parentId\",\n        displayExpr: \"caption\",\n        onItemClick: function (e) {\n          if (item !== e.itemData) {\n            item = e.itemData;\n            condition[0] = item.name || item.dataField;\n            condition[2] = \"object\" === item.dataType ? null : \"\";\n\n            _utils2.default.updateConditionByOperation(condition, _utils2.default.getDefaultOperation(item), that._customOperations);\n\n            $fieldButton.siblings().filter(\".\" + FILTER_BUILDER_ITEM_TEXT_CLASS).remove();\n\n            that._createOperationAndValueButtons(condition, item, $fieldButton.parent());\n\n            var caption = getFullCaption(item, e.component.option(\"items\"));\n            $fieldButton.html(caption);\n\n            _this4._updateFilter();\n          }\n        },\n        onContentReady: function (e) {\n          e.component.selectItem(item);\n        },\n        cssClass: FILTER_BUILDER_FIELDS_CLASS\n      }\n    }).addClass(FILTER_BUILDER_ITEM_TEXT_CLASS).addClass(FILTER_BUILDER_ITEM_FIELD_CLASS).attr(\"tabindex\", 0);\n\n    return $fieldButton;\n  },\n  _createConditionItem: function (condition, parent) {\n    var _this5 = this;\n\n    var $item = (0, _renderer2.default)(\"<div>\").addClass(FILTER_BUILDER_GROUP_ITEM_CLASS);\n\n    var fields = this._getNormalizedFields();\n\n    var field = _utils2.default.getField(condition[0], fields);\n\n    this._createRemoveButton(function () {\n      _utils2.default.removeItem(parent, condition);\n\n      var isSingleChild = 1 === $item.parent().children().length;\n\n      if (isSingleChild) {\n        $item.parent().remove();\n      } else {\n        $item.remove();\n      }\n\n      _this5._updateFilter();\n    }).appendTo($item);\n\n    this._createFieldButtonWithMenu(fields, condition, field).appendTo($item);\n\n    this._createOperationAndValueButtons(condition, field, $item);\n\n    return $item;\n  },\n  _getGroupOperations: function (criteria) {\n    var groupOperations = this.option(\"groupOperations\");\n    var groupOperationDescriptions = this.option(\"groupOperationDescriptions\");\n\n    if (!groupOperations || !groupOperations.length) {\n      groupOperations = [_utils2.default.getGroupValue(criteria).replace(\"!\", \"not\")];\n    }\n\n    return groupOperations.map(function (operation) {\n      return {\n        text: groupOperationDescriptions[operation],\n        value: OPERATORS[operation]\n      };\n    });\n  },\n  _createRemoveButton: function (handler) {\n    var $removeButton = (0, _renderer2.default)(\"<div>\").addClass(FILTER_BUILDER_IMAGE_CLASS).addClass(FILTER_BUILDER_IMAGE_REMOVE_CLASS).addClass(FILTER_BUILDER_ACTION_CLASS).attr(\"tabindex\", 0);\n\n    this._subscribeOnClickAndEnterKey($removeButton, handler);\n\n    return $removeButton;\n  },\n  _createAddButton: function (addGroupHandler, addConditionHandler, groupLevel) {\n    var $button;\n    var maxGroupLevel = this.option(\"maxGroupLevel\");\n\n    if ((0, _type.isDefined)(maxGroupLevel) && groupLevel >= maxGroupLevel) {\n      $button = this._createButton();\n\n      this._subscribeOnClickAndEnterKey($button, addConditionHandler);\n    } else {\n      $button = this._createButtonWithMenu({\n        menu: {\n          items: [{\n            caption: _message2.default.format(\"dxFilterBuilder-addCondition\"),\n            click: addConditionHandler\n          }, {\n            caption: _message2.default.format(\"dxFilterBuilder-addGroup\"),\n            click: addGroupHandler\n          }],\n          displayExpr: \"caption\",\n          onItemClick: function (e) {\n            e.itemData.click();\n          },\n          cssClass: FILTER_BUILDER_ADD_CONDITION_CLASS\n        }\n      });\n    }\n\n    return $button.addClass(FILTER_BUILDER_IMAGE_CLASS).addClass(FILTER_BUILDER_IMAGE_ADD_CLASS).addClass(FILTER_BUILDER_ACTION_CLASS).attr(\"tabindex\", 0);\n  },\n  _createValueText: function (item, field, $container) {\n    var that = this;\n    var $text = (0, _renderer2.default)(\"<div>\").html(\"&nbsp;\").addClass(FILTER_BUILDER_ITEM_VALUE_TEXT_CLASS).attr(\"tabindex\", 0).appendTo($container);\n    var value = item[2];\n\n    var customOperation = _utils2.default.getCustomOperation(that._customOperations, item[1]);\n\n    if (!customOperation && field.lookup) {\n      _utils2.default.getCurrentLookupValueText(field, value, function (result) {\n        renderValueText($text, result);\n      });\n    } else {\n      _deferred2.default.when(_utils2.default.getCurrentValueText(field, value, customOperation)).done(function (result) {\n        renderValueText($text, result, customOperation);\n      });\n    }\n\n    that._subscribeOnClickAndEnterKey($text, function (e) {\n      if (\"keyup\" === e.type) {\n        e.stopPropagation();\n      }\n\n      that._createValueEditorWithEvents(item, field, $container);\n    });\n\n    return $text;\n  },\n  _updateConditionValue: function (item, value, callback) {\n    var areValuesDifferent = item[2] !== value;\n\n    if (areValuesDifferent) {\n      item[2] = value;\n    }\n\n    callback();\n\n    this._updateFilter();\n  },\n  _addDocumentKeyUp: function ($editor, handler) {\n    var isComposing = false;\n    var hasCompositionJustEnded = false;\n\n    var document = _dom_adapter2.default.getDocument();\n\n    var documentKeyUpHandler = function (e) {\n      if (isComposing || hasCompositionJustEnded) {\n        hasCompositionJustEnded = false;\n        return;\n      }\n\n      handler(e);\n    };\n\n    _events_engine2.default.on(document, \"keyup\", documentKeyUpHandler);\n\n    var input = $editor.find(\"input\");\n\n    _events_engine2.default.on(input, \"compositionstart\", function () {\n      isComposing = true;\n    });\n\n    _events_engine2.default.on(input, \"compositionend\", function () {\n      isComposing = false;\n      hasCompositionJustEnded = true;\n    });\n\n    _events_engine2.default.on(input, \"keydown\", function (event) {\n      if (229 !== event.which) {\n        hasCompositionJustEnded = false;\n      }\n    });\n\n    this._documentKeyUpHandler = documentKeyUpHandler;\n  },\n  _addDocumentClick: function ($editor, closeEditorFunc) {\n    var _this6 = this;\n\n    var document = _dom_adapter2.default.getDocument();\n\n    var documentClickHandler = function (e) {\n      if (!_this6._isFocusOnEditorParts($editor, e.target)) {\n        _events_engine2.default.trigger($editor.find(\"input\"), \"change\");\n\n        closeEditorFunc();\n      }\n    };\n\n    _events_engine2.default.on(document, \"dxpointerdown\", documentClickHandler);\n\n    this._documentClickHandler = documentClickHandler;\n  },\n  _isFocusOnEditorParts: function ($editor, target) {\n    var activeElement = target || _dom_adapter2.default.getActiveElement();\n\n    return (0, _renderer2.default)(activeElement).closest($editor.children()).length || (0, _renderer2.default)(activeElement).closest(\".dx-dropdowneditor-overlay\").length;\n  },\n  _removeEvents: function () {\n    var document = _dom_adapter2.default.getDocument();\n\n    (0, _type.isDefined)(this._documentKeyUpHandler) && _events_engine2.default.off(document, \"keyup\", this._documentKeyUpHandler);\n    (0, _type.isDefined)(this._documentClickHandler) && _events_engine2.default.off(document, \"dxpointerdown\", this._documentClickHandler);\n  },\n  _dispose: function () {\n    this._removeEvents();\n\n    this.callBase();\n  },\n  _createValueEditorWithEvents: function (item, field, $container) {\n    var _this7 = this;\n\n    var value = item[2];\n\n    var createValueText = function () {\n      $container.empty();\n\n      _this7._removeEvents();\n\n      return _this7._createValueText(item, field, $container);\n    };\n\n    var closeEditor = function () {\n      _this7._updateConditionValue(item, value, function () {\n        createValueText();\n      });\n    };\n\n    var options = {\n      value: \"\" === value ? null : value,\n      filterOperation: _utils2.default.getOperationValue(item),\n      setValue: function (data) {\n        value = null === data ? \"\" : data;\n      },\n      closeEditor: closeEditor,\n      text: $container.text()\n    };\n    $container.empty();\n\n    var $editor = this._createValueEditor($container, field, options);\n\n    _events_engine2.default.trigger($editor.find(\"input\").not(\":hidden\").eq(0), \"focus\");\n\n    this._removeEvents();\n\n    this._addDocumentClick($editor, closeEditor);\n\n    this._addDocumentKeyUp($editor, function (e) {\n      var keyName = (0, _utils4.normalizeKeyName)(e);\n\n      if (keyName === TAB_KEY) {\n        if (_this7._isFocusOnEditorParts($editor)) {\n          return;\n        }\n\n        _this7._updateConditionValue(item, value, function () {\n          createValueText();\n\n          if (e.shiftKey) {\n            _events_engine2.default.trigger($container.prev(), \"focus\");\n          }\n        });\n      }\n\n      if (keyName === ESCAPE_KEY) {\n        _events_engine2.default.trigger(createValueText(), \"focus\");\n      }\n\n      if (keyName === ENTER_KEY) {\n        _this7._updateConditionValue(item, value, function () {\n          _events_engine2.default.trigger(createValueText(), \"focus\");\n        });\n      }\n    });\n\n    this._fireContentReadyAction();\n  },\n  _createValueButton: function (item, field) {\n    var $valueButton = (0, _renderer2.default)(\"<div>\").addClass(FILTER_BUILDER_ITEM_TEXT_CLASS).addClass(FILTER_BUILDER_ITEM_VALUE_CLASS);\n\n    this._createValueText(item, field, $valueButton);\n\n    return $valueButton;\n  },\n  _createValueEditor: function ($container, field, options) {\n    var $editor = (0, _renderer2.default)(\"<div>\").attr(\"tabindex\", 0).appendTo($container);\n\n    var customOperation = _utils2.default.getCustomOperation(this._customOperations, options.filterOperation);\n\n    var editorTemplate = customOperation && customOperation.editorTemplate ? customOperation.editorTemplate : field.editorTemplate;\n\n    if (editorTemplate) {\n      var template = this._getTemplate(editorTemplate);\n\n      template.render({\n        model: (0, _extend.extend)({\n          field: field\n        }, options),\n        container: $editor\n      });\n    } else {\n      this._editorFactory.createEditor.call(this, $editor, (0, _extend.extend)({}, field, options, {\n        parentType: SOURCE\n      }));\n    }\n\n    return $editor;\n  },\n  _createPopupWithTreeView: function (options, $container) {\n    var that = this;\n    var $popup = (0, _renderer2.default)(\"<div>\").addClass(options.menu.cssClass).appendTo($container);\n\n    this._createComponent($popup, _popup2.default, {\n      onHiding: options.menu.onHiding,\n      onHidden: options.menu.onHidden,\n      rtlEnabled: options.menu.rtlEnabled,\n      position: options.menu.position,\n      animation: options.menu.animation,\n      contentTemplate: function (contentElement) {\n        var $menuContainer = (0, _renderer2.default)(\"<div>\").appendTo(contentElement);\n\n        that._createComponent($menuContainer, _tree_view2.default, options.menu);\n\n        this.repaint();\n      },\n      maxHeight: function () {\n        return (0, _utils3.getElementMaxHeightByWindow)(options.menu.position.of);\n      },\n      visible: true,\n      focusStateEnabled: false,\n      closeOnTargetScroll: this.option(\"closePopupOnTargetScroll\"),\n      closeOnOutsideClick: true,\n      onShown: options.popup.onShown,\n      shading: false,\n      width: \"auto\",\n      height: \"auto\",\n      showTitle: false\n    });\n  },\n  _subscribeOnClickAndEnterKey: function ($button, handler) {\n    _events_engine2.default.on($button, \"dxclick\", handler);\n\n    _events_engine2.default.on($button, \"keyup\", function (e) {\n      if ((0, _utils4.normalizeKeyName)(e) === ENTER_KEY) {\n        handler(e);\n      }\n    });\n  }\n});\n\n(0, _component_registrator2.default)(\"dxFilterBuilder\", FilterBuilder);\nmodule.exports = FilterBuilder;\nmodule.exports.renderValueText = renderValueText;","map":null,"metadata":{},"sourceType":"script"}