{"ast":null,"code":"/**\r\n * DevExtreme (ui/date_box/ui.date_box.strategy.list.js)\r\n * Version: 20.1.6\r\n * Build date: Fri Jul 17 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar $ = require(\"../../core/renderer\");\n\nvar window = require(\"../../core/utils/window\").getWindow();\n\nvar List = require(\"../list\");\n\nvar DateBoxStrategy = require(\"./ui.date_box.strategy\");\n\nvar noop = require(\"../../core/utils/common\").noop;\n\nvar ensureDefined = require(\"../../core/utils/common\").ensureDefined;\n\nvar isDate = require(\"../../core/utils/type\").isDate;\n\nvar extend = require(\"../../core/utils/extend\").extend;\n\nvar dateUtils = require(\"./ui.date_utils\");\n\nvar dateLocalization = require(\"../../localization/date\");\n\nvar dateSerialization = require(\"../../core/utils/date_serialization\");\n\nvar DATE_FORMAT = \"date\";\nvar BOUNDARY_VALUES = {\n  min: new Date(0, 0, 0, 0, 0),\n  max: new Date(0, 0, 0, 23, 59)\n};\nvar ListStrategy = DateBoxStrategy.inherit({\n  NAME: \"List\",\n  supportedKeys: function () {\n    return {\n      tab: function () {\n        if (this.option(\"opened\")) {\n          this.close();\n        }\n      },\n      space: noop,\n      home: noop,\n      end: noop\n    };\n  },\n  getDefaultOptions: function () {\n    return extend(this.callBase(), {\n      applyValueMode: \"instantly\"\n    });\n  },\n  getDisplayFormat: function (displayFormat) {\n    return displayFormat || \"shorttime\";\n  },\n  popupConfig: function (_popupConfig) {\n    return _popupConfig;\n  },\n  useCurrentDateByDefault: function () {\n    return true;\n  },\n  getDefaultDate: function () {\n    return new Date(null);\n  },\n  popupShowingHandler: function () {\n    this._dimensionChanged();\n  },\n  _renderWidget: function () {\n    this.callBase();\n\n    this._refreshItems();\n  },\n  _getWidgetName: function () {\n    return List;\n  },\n  _getWidgetOptions: function () {\n    return {\n      itemTemplate: this._timeListItemTemplate.bind(this),\n      onItemClick: this._listItemClickHandler.bind(this),\n      tabIndex: -1,\n      onFocusedItemChanged: this._refreshActiveDescendant.bind(this),\n      selectionMode: \"single\"\n    };\n  },\n  _refreshActiveDescendant: function (e) {\n    this.dateBox.setAria(\"activedescendant\", \"\");\n    this.dateBox.setAria(\"activedescendant\", e.actionValue);\n  },\n  _refreshItems: function () {\n    this._widgetItems = this._getTimeListItems();\n\n    this._widget.option(\"items\", this._widgetItems);\n  },\n  renderOpenedState: function () {\n    if (!this._widget) {\n      return;\n    }\n\n    this._widget.option(\"focusedElement\", null);\n\n    this._setSelectedItemsByValue();\n\n    if (this._widget.option(\"templatesRenderAsynchronously\")) {\n      this._asyncScrollTimeout = setTimeout(this._scrollToSelectedItem.bind(this));\n    } else {\n      this._scrollToSelectedItem();\n    }\n  },\n  dispose: function () {\n    this.callBase();\n    clearTimeout(this._asyncScrollTimeout);\n  },\n  _updateValue: function () {\n    if (!this._widget) {\n      return;\n    }\n\n    this._refreshItems();\n\n    this._setSelectedItemsByValue();\n\n    this._scrollToSelectedItem();\n  },\n  _setSelectedItemsByValue: function () {\n    var value = this.dateBoxValue();\n\n    var dateIndex = this._getDateIndex(value);\n\n    if (dateIndex === -1) {\n      this._widget.option(\"selectedItems\", []);\n    } else {\n      this._widget.option(\"selectedIndex\", dateIndex);\n    }\n  },\n  _scrollToSelectedItem: function () {\n    this._widget.scrollToItem(this._widget.option(\"selectedIndex\"));\n  },\n  _getDateIndex: function (date) {\n    var result = -1;\n\n    for (var i = 0, n = this._widgetItems.length; i < n; i++) {\n      if (this._areDatesEqual(date, this._widgetItems[i])) {\n        result = i;\n        break;\n      }\n    }\n\n    return result;\n  },\n  _areDatesEqual: function (first, second) {\n    return isDate(first) && isDate(second) && first.getHours() === second.getHours() && first.getMinutes() === second.getMinutes();\n  },\n  _getTimeListItems: function () {\n    var min = this.dateBox.dateOption(\"min\") || this._getBoundaryDate(\"min\");\n\n    var max = this.dateBox.dateOption(\"max\") || this._getBoundaryDate(\"max\");\n\n    var value = this.dateBox.dateOption(\"value\") || null;\n    var delta = max - min;\n    var minutes = min.getMinutes() % this.dateBox.option(\"interval\");\n\n    if (delta < 0) {\n      return [];\n    }\n\n    if (delta > dateUtils.ONE_DAY) {\n      delta = dateUtils.ONE_DAY;\n    }\n\n    if (value - min < dateUtils.ONE_DAY) {\n      return this._getRangeItems(min, new Date(min), delta);\n    }\n\n    min = this._getBoundaryDate(\"min\");\n    min.setMinutes(minutes);\n\n    if (value && Math.abs(value - max) < dateUtils.ONE_DAY) {\n      delta = (60 * max.getHours() + Math.abs(max.getMinutes() - minutes)) * dateUtils.ONE_MINUTE;\n    }\n\n    return this._getRangeItems(min, new Date(min), delta);\n  },\n  _getRangeItems: function (startValue, currentValue, rangeDuration) {\n    var rangeItems = [];\n    var interval = this.dateBox.option(\"interval\");\n\n    while (currentValue - startValue <= rangeDuration) {\n      rangeItems.push(new Date(currentValue));\n      currentValue.setMinutes(currentValue.getMinutes() + interval);\n    }\n\n    return rangeItems;\n  },\n  _getBoundaryDate: function (boundary) {\n    var boundaryValue = BOUNDARY_VALUES[boundary];\n    var currentValue = new Date(ensureDefined(this.dateBox.dateOption(\"value\"), 0));\n    return new Date(currentValue.getFullYear(), currentValue.getMonth(), currentValue.getDate(), boundaryValue.getHours(), boundaryValue.getMinutes());\n  },\n  _timeListItemTemplate: function (itemData) {\n    var displayFormat = this.dateBox.option(\"displayFormat\");\n    return dateLocalization.format(itemData, this.getDisplayFormat(displayFormat));\n  },\n  _listItemClickHandler: function (e) {\n    this.dateBox.option(\"opened\", false);\n    var date = this.dateBox.option(\"value\");\n    var itemData = e.itemData;\n    var hours = itemData.getHours();\n    var minutes = itemData.getMinutes();\n    var seconds = itemData.getSeconds();\n    var year = itemData.getFullYear();\n    var month = itemData.getMonth();\n    var day = itemData.getDate();\n\n    if (date) {\n      if (this.dateBox.option(\"dateSerializationFormat\")) {\n        date = dateSerialization.deserializeDate(date);\n      } else {\n        date = new Date(date);\n      }\n\n      date.setHours(hours);\n      date.setMinutes(minutes);\n      date.setSeconds(seconds);\n      date.setFullYear(year);\n      date.setMonth(month);\n      date.setDate(day);\n    } else {\n      date = new Date(year, month, day, hours, minutes, 0, 0);\n    }\n\n    this.dateBoxValue(date, e.event);\n  },\n  getKeyboardListener: function () {\n    return this._widget;\n  },\n  _dimensionChanged: function () {\n    if (this._getPopup()) {\n      this._updatePopupHeight();\n    }\n  },\n  _updatePopupHeight: function () {\n    this.dateBox._setPopupOption(\"height\", \"auto\");\n\n    var popupHeight = this._widget.$element().outerHeight();\n\n    var maxHeight = .45 * $(window).height();\n\n    this.dateBox._setPopupOption(\"height\", Math.min(popupHeight, maxHeight));\n\n    this.dateBox._timeList && this.dateBox._timeList.updateDimensions();\n  },\n  getParsedText: function (text, format) {\n    var value = this.callBase(text, format);\n\n    if (value) {\n      value = dateUtils.mergeDates(value, new Date(null), DATE_FORMAT);\n    }\n\n    return value;\n  }\n});\nmodule.exports = ListStrategy;","map":null,"metadata":{},"sourceType":"script"}