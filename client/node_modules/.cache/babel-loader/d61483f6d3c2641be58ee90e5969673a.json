{"ast":null,"code":"/**\r\n * DevExtreme (ui/data_grid/ui.data_grid.focus.js)\r\n * Version: 20.1.6\r\n * Build date: Fri Jul 17 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _uiData_grid = require(\"./ui.data_grid.core\");\n\nvar _uiData_grid2 = _interopRequireDefault(_uiData_grid);\n\nvar _uiGrid_core = require(\"../grid_core/ui.grid_core.focus\");\n\nvar _uiGrid_core2 = _interopRequireDefault(_uiGrid_core);\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _common = require(\"../../core/utils/common\");\n\nvar _uiData_grid3 = require(\"./ui.data_grid.utils\");\n\nvar _data = require(\"../../core/utils/data\");\n\nvar _extend = require(\"../../core/utils/extend\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar MAX_SAFE_INTEGER = Number.MAX_SAFE_INTEGER || 9007199254740991;\n\n_uiData_grid2.default.registerModule(\"focus\", (0, _extend.extend)(true, {}, _uiGrid_core2.default, {\n  extenders: {\n    controllers: {\n      data: {\n        changeRowExpand: function (path) {\n          if (this.option(\"focusedRowEnabled\") && Array.isArray(path) && this.isRowExpanded(path)) {\n            if (this._isFocusedRowInsideGroup(path)) {\n              this.option(\"focusedRowKey\", path);\n            }\n          }\n\n          return this.callBase.apply(this, arguments);\n        },\n        _isFocusedRowInsideGroup: function (path) {\n          var columnsController = this.getController(\"columns\");\n          var focusedRowKey = this.option(\"focusedRowKey\");\n          var rowIndex = this.getRowIndexByKey(focusedRowKey);\n          var focusedRow = rowIndex >= 0 && this.getVisibleRows()[rowIndex];\n          var groups = columnsController.getGroupDataSourceParameters(true);\n\n          if (focusedRow) {\n            for (var i = 0; i < path.length; ++i) {\n              var getter = (0, _data.compileGetter)(groups[i] && groups[i].selector);\n\n              if (getter(focusedRow.data) !== path[i]) {\n                return false;\n              }\n            }\n          }\n\n          return true;\n        },\n        _getGroupPath: function (group) {\n          var groupPath = [group.key];\n          var items = group.items;\n\n          while (items && items[0]) {\n            var item = items[0];\n\n            if (void 0 !== item.key) {\n              groupPath.push(item.key);\n            }\n\n            items = item.items;\n          }\n\n          return groupPath;\n        },\n        _expandGroupByPath: function (that, groupPath, level) {\n          var d = new _deferred.Deferred();\n          level++;\n          that.expandRow(groupPath.slice(0, level)).done(function () {\n            if (level === groupPath.length) {\n              d.resolve();\n            } else {\n              that._expandGroupByPath(that, groupPath, level).done(d.resolve).fail(d.reject);\n            }\n          }).fail(d.reject);\n          return d.promise();\n        },\n        _calculateGlobalRowIndexByGroupedData: function (key) {\n          var that = this;\n          var dataSource = that._dataSource;\n\n          var filter = that._generateFilterByKey(key);\n\n          var deferred = new _deferred.Deferred();\n          var isGroupKey = Array.isArray(key);\n          var group = dataSource.group();\n\n          if (isGroupKey) {\n            return deferred.resolve(-1).promise();\n          }\n\n          if (!dataSource._grouping._updatePagingOptions) {\n            that._calculateGlobalRowIndexByFlatData(key, null, true).done(deferred.resolve).fail(deferred.reject);\n\n            return deferred;\n          }\n\n          dataSource.load({\n            filter: that._concatWithCombinedFilter(filter),\n            group: group\n          }).done(function (data) {\n            if (!data || 0 === data.length || !(0, _type.isDefined)(data[0].key) || data[0].key === -1) {\n              return deferred.resolve(-1).promise();\n            }\n\n            var groupPath = that._getGroupPath(data[0]);\n\n            that._expandGroupByPath(that, groupPath, 0).done(function () {\n              that._calculateExpandedRowGlobalIndex(deferred, key, groupPath, group);\n            }).fail(deferred.reject);\n          }).fail(deferred.reject);\n          return deferred.promise();\n        },\n        _calculateExpandedRowGlobalIndex: function (deferred, key, groupPath, group) {\n          var groupFilter = (0, _uiData_grid3.createGroupFilter)(groupPath, {\n            group: group\n          });\n          var dataSource = this._dataSource;\n          var scrollingMode = this.option(\"scrolling.mode\");\n          var isVirtualScrolling = \"virtual\" === scrollingMode || \"infinite\" === scrollingMode;\n          var pageSize = dataSource.pageSize();\n          var groupOffset;\n\n          dataSource._grouping._updatePagingOptions({\n            skip: 0,\n            take: MAX_SAFE_INTEGER\n          }, function (groupInfo, totalOffset) {\n            if ((0, _common.equalByValue)(groupInfo.path, groupPath)) {\n              groupOffset = totalOffset;\n            }\n          });\n\n          this._calculateGlobalRowIndexByFlatData(key, groupFilter).done(function (dataOffset) {\n            var count;\n            var groupContinuationCount;\n\n            if (dataOffset < 0) {\n              deferred.resolve(-1);\n              return;\n            }\n\n            var currentPageOffset = groupOffset % pageSize || pageSize;\n            count = currentPageOffset + dataOffset - groupPath.length;\n\n            if (isVirtualScrolling) {\n              groupContinuationCount = 0;\n            } else {\n              groupContinuationCount = Math.floor(count / (pageSize - groupPath.length)) * groupPath.length;\n            }\n\n            count = groupOffset + dataOffset + groupContinuationCount;\n            deferred.resolve(count);\n          }).fail(deferred.reject);\n        }\n      }\n    }\n  }\n}));","map":null,"metadata":{},"sourceType":"script"}