{"ast":null,"code":"/**\r\n * DevExtreme (ui/date_box/ui.date_view.js)\r\n * Version: 20.1.6\r\n * Build date: Fri Jul 17 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar $ = require(\"../../core/renderer\");\n\nvar Editor = require(\"../editor/editor\");\n\nvar DateViewRoller = require(\"./ui.date_view_roller\");\n\nvar dateUtils = require(\"../../core/utils/date\");\n\nvar each = require(\"../../core/utils/iterator\").each;\n\nvar extend = require(\"../../core/utils/extend\").extend;\n\nvar uiDateUtils = require(\"./ui.date_utils\");\n\nvar registerComponent = require(\"../../core/component_registrator\");\n\nvar dateLocalization = require(\"../../localization/date\");\n\nvar DATEVIEW_CLASS = \"dx-dateview\";\nvar DATEVIEW_COMPACT_CLASS = \"dx-dateview-compact\";\nvar DATEVIEW_WRAPPER_CLASS = \"dx-dateview-wrapper\";\nvar DATEVIEW_ROLLER_CONTAINER_CLASS = \"dx-dateview-rollers\";\nvar DATEVIEW_ROLLER_CLASS = \"dx-dateviewroller\";\nvar TYPE = {\n  date: \"date\",\n  datetime: \"datetime\",\n  time: \"time\"\n};\nvar ROLLER_TYPE = {\n  year: \"year\",\n  month: \"month\",\n  day: \"day\",\n  hours: \"hours\"\n};\nvar DateView = Editor.inherit({\n  _valueOption: function () {\n    var value = this.option(\"value\");\n    var date = new Date(value);\n    return !value || isNaN(date) ? this._getDefaultDate() : date;\n  },\n  _getDefaultDate: function () {\n    var date = new Date();\n\n    if (this.option(\"type\") === TYPE.date) {\n      return new Date(date.getFullYear(), date.getMonth(), date.getDate());\n    }\n\n    return date;\n  },\n  _getDefaultOptions: function () {\n    return extend(this.callBase(), {\n      minDate: uiDateUtils.MIN_DATEVIEW_DEFAULT_DATE,\n      maxDate: uiDateUtils.MAX_DATEVIEW_DEFAULT_DATE,\n      type: TYPE.date,\n      value: new Date(),\n      applyCompactClass: false\n    });\n  },\n  _defaultOptionsRules: function () {\n    return this.callBase().concat([{\n      device: function (_device) {\n        return \"desktop\" !== _device.deviceType;\n      },\n      options: {\n        applyCompactClass: true\n      }\n    }]);\n  },\n  _render: function () {\n    this.callBase();\n    this.$element().addClass(DATEVIEW_CLASS);\n\n    this._toggleFormatClasses(this.option(\"type\"));\n\n    this._toggleCompactClass();\n  },\n  _toggleFormatClasses: function (currentFormat, previousFormat) {\n    this.$element().addClass(DATEVIEW_CLASS + \"-\" + currentFormat);\n    previousFormat && this.$element().removeClass(DATEVIEW_CLASS + \"-\" + previousFormat);\n  },\n  _toggleCompactClass: function () {\n    this.$element().toggleClass(DATEVIEW_COMPACT_CLASS, this.option(\"applyCompactClass\"));\n  },\n  _wrapper: function () {\n    return this._$wrapper;\n  },\n  _renderContentImpl: function () {\n    this._$wrapper = $(\"<div>\").addClass(DATEVIEW_WRAPPER_CLASS);\n\n    this._renderRollers();\n\n    this._$wrapper.appendTo(this.$element());\n  },\n  _renderRollers: function () {\n    if (!this._$rollersContainer) {\n      this._$rollersContainer = $(\"<div>\").addClass(DATEVIEW_ROLLER_CONTAINER_CLASS);\n    }\n\n    this._$rollersContainer.empty();\n\n    this._createRollerConfigs();\n\n    this._rollers = {};\n    var that = this;\n    each(that._rollerConfigs, function (name) {\n      var $roller = $(\"<div>\").appendTo(that._$rollersContainer).addClass(DATEVIEW_ROLLER_CLASS + \"-\" + that._rollerConfigs[name].type);\n      that._rollers[that._rollerConfigs[name].type] = that._createComponent($roller, DateViewRoller, {\n        items: that._rollerConfigs[name].displayItems,\n        selectedIndex: that._rollerConfigs[name].selectedIndex,\n        showScrollbar: false,\n        onStart: function (e) {\n          var roller = e.component;\n\n          roller._toggleActive(true);\n\n          that._setActiveRoller(that._rollerConfigs[name], roller.option(\"selectedIndex\"));\n        },\n        onEnd: function (e) {\n          var roller = e.component;\n\n          roller._toggleActive(false);\n        },\n        onClick: function (e) {\n          var roller = e.component;\n\n          roller._toggleActive(true);\n\n          that._setActiveRoller(that._rollerConfigs[name], roller.option(\"selectedIndex\"));\n\n          that._setRollerState(that._rollerConfigs[name], roller.option(\"selectedIndex\"));\n\n          roller._toggleActive(false);\n        },\n        onSelectedIndexChanged: function (e) {\n          var roller = e.component;\n\n          that._setRollerState(that._rollerConfigs[name], roller.option(\"selectedIndex\"));\n        }\n      });\n    });\n\n    that._$rollersContainer.appendTo(that._wrapper());\n  },\n  _createRollerConfigs: function (type) {\n    var that = this;\n    type = type || that.option(\"type\");\n    that._rollerConfigs = {};\n    dateLocalization.getFormatParts(uiDateUtils.FORMATS_MAP[type]).forEach(function (partName) {\n      that._createRollerConfig(partName);\n    });\n  },\n  _createRollerConfig: function (componentName) {\n    var componentInfo = uiDateUtils.DATE_COMPONENTS_INFO[componentName];\n\n    var valueRange = this._calculateRollerConfigValueRange(componentName);\n\n    var startValue = valueRange.startValue;\n    var endValue = valueRange.endValue;\n    var formatter = componentInfo.formatter;\n\n    var curDate = this._getCurrentDate();\n\n    var config = {\n      type: componentName,\n      setValue: componentInfo.setter,\n      valueItems: [],\n      displayItems: [],\n      getIndex: function (value) {\n        return value[componentInfo.getter]() - startValue;\n      }\n    };\n\n    for (var i = startValue; i <= endValue; i++) {\n      config.valueItems.push(i);\n      config.displayItems.push(formatter(i, curDate));\n    }\n\n    config.selectedIndex = config.getIndex(curDate);\n    this._rollerConfigs[componentName] = config;\n  },\n  _setActiveRoller: function (currentRoller) {\n    var activeRoller = currentRoller && this._rollers[currentRoller.type];\n    each(this._rollers, function () {\n      this.toggleActiveState(this === activeRoller);\n    });\n  },\n  _updateRollersPosition: function () {\n    var that = this;\n    each(this._rollers, function (type) {\n      var correctIndex = that._rollerConfigs[type].getIndex(that._getCurrentDate());\n\n      this.option(\"selectedIndex\", correctIndex);\n    });\n  },\n  _setRollerState: function (roller, selectedIndex) {\n    if (selectedIndex !== roller.selectedIndex) {\n      var rollerValue = roller.valueItems[selectedIndex];\n      var setValue = roller.setValue;\n      var currentValue = new Date(this._getCurrentDate());\n      var currentDate = currentValue.getDate();\n      var minDate = this.option(\"minDate\");\n      var maxDate = this.option(\"maxDate\");\n\n      if (roller.type === ROLLER_TYPE.month) {\n        currentDate = Math.min(currentDate, uiDateUtils.getMaxMonthDay(currentValue.getFullYear(), rollerValue));\n      } else {\n        if (roller.type === ROLLER_TYPE.year) {\n          currentDate = Math.min(currentDate, uiDateUtils.getMaxMonthDay(rollerValue, currentValue.getMonth()));\n        }\n      }\n\n      currentValue.setDate(currentDate);\n      currentValue[setValue](rollerValue);\n      var normalizedDate = dateUtils.normalizeDate(currentValue, minDate, maxDate);\n      currentValue = uiDateUtils.mergeDates(normalizedDate, currentValue, \"time\");\n      currentValue = dateUtils.normalizeDate(currentValue, minDate, maxDate);\n      this.option(\"value\", currentValue);\n      roller.selectedIndex = selectedIndex;\n    }\n\n    if (roller.type === ROLLER_TYPE.year) {\n      this._refreshRollers();\n    }\n\n    if (roller.type === ROLLER_TYPE.month) {\n      this._refreshRoller(ROLLER_TYPE.day);\n\n      this._refreshRoller(ROLLER_TYPE.hours);\n    }\n  },\n  _refreshRoller: function (rollerType) {\n    var roller = this._rollers[rollerType];\n\n    if (roller) {\n      this._createRollerConfig(rollerType);\n\n      var rollerConfig = this._rollerConfigs[rollerType];\n\n      if (rollerType === ROLLER_TYPE.day || rollerConfig.displayItems.toString() !== roller.option(\"items\").toString()) {\n        roller.option({\n          items: rollerConfig.displayItems,\n          selectedIndex: rollerConfig.selectedIndex\n        });\n      }\n    }\n  },\n  _getCurrentDate: function () {\n    var curDate = this._valueOption();\n\n    var minDate = this.option(\"minDate\");\n    var maxDate = this.option(\"maxDate\");\n    return dateUtils.normalizeDate(curDate, minDate, maxDate);\n  },\n  _calculateRollerConfigValueRange: function (componentName) {\n    var curDate = this._getCurrentDate();\n\n    var minDate = this.option(\"minDate\");\n    var maxDate = this.option(\"maxDate\");\n    var minYear = dateUtils.sameYear(curDate, minDate);\n    var minMonth = minYear && curDate.getMonth() === minDate.getMonth();\n    var maxYear = dateUtils.sameYear(curDate, maxDate);\n    var maxMonth = maxYear && curDate.getMonth() === maxDate.getMonth();\n    var minHour = minMonth && curDate.getDate() === minDate.getDate();\n    var maxHour = maxMonth && curDate.getDate() === maxDate.getDate();\n    var componentInfo = uiDateUtils.DATE_COMPONENTS_INFO[componentName];\n    var startValue = componentInfo.startValue;\n    var endValue = componentInfo.endValue;\n\n    if (componentName === ROLLER_TYPE.year) {\n      startValue = minDate.getFullYear();\n      endValue = maxDate.getFullYear();\n    }\n\n    if (componentName === ROLLER_TYPE.month) {\n      if (minYear) {\n        startValue = minDate.getMonth();\n      }\n\n      if (maxYear) {\n        endValue = maxDate.getMonth();\n      }\n    }\n\n    if (componentName === ROLLER_TYPE.day) {\n      endValue = uiDateUtils.getMaxMonthDay(curDate.getFullYear(), curDate.getMonth());\n\n      if (minYear && minMonth) {\n        startValue = minDate.getDate();\n      }\n\n      if (maxYear && maxMonth) {\n        endValue = maxDate.getDate();\n      }\n    }\n\n    if (componentName === ROLLER_TYPE.hours) {\n      startValue = minHour ? minDate.getHours() : startValue;\n      endValue = maxHour ? maxDate.getHours() : endValue;\n    }\n\n    return {\n      startValue: startValue,\n      endValue: endValue\n    };\n  },\n  _refreshRollers: function () {\n    this._refreshRoller(ROLLER_TYPE.month);\n\n    this._refreshRoller(ROLLER_TYPE.day);\n\n    this._refreshRoller(ROLLER_TYPE.hours);\n  },\n  _optionChanged: function (args) {\n    switch (args.name) {\n      case \"minDate\":\n      case \"maxDate\":\n      case \"type\":\n        this._renderRollers();\n\n        this._toggleFormatClasses(args.value, args.previousValue);\n\n        break;\n\n      case \"visible\":\n        this.callBase(args);\n\n        if (args.value) {\n          this._renderRollers();\n        }\n\n        break;\n\n      case \"value\":\n        this.option(\"value\", this._valueOption());\n\n        this._refreshRollers();\n\n        this._updateRollersPosition();\n\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  },\n  _clean: function () {\n    this.callBase();\n    delete this._$rollersContainer;\n  },\n  _dispose: function () {\n    clearTimeout(this._deferredRenderDayTimeout);\n    clearTimeout(this._deferredRenderMonthTimeout);\n    this.callBase();\n  }\n});\nregisterComponent(\"dxDateView\", DateView);\nmodule.exports = DateView;","map":null,"metadata":{},"sourceType":"script"}